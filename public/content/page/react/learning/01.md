# reactå­¦ä¹ -01

| æ–‡æ¡£åˆ›å»ºäºº | åˆ›å»ºæ—¥æœŸ   | æ–‡æ¡£å†…å®¹                      | æ›´æ–°æ—¶é—´   |
| ---------- | ---------- | ----------------------------- | ---------- |
| adsionli   | 2022-11-24 | reactå­¦ä¹ -jsx,component,state | 2022-11-24 |

ç»ˆäºå¼€å§‹å­¦ä¹ reactäº†ï¼Œå› ä¸ºç§‹æ‹›çš„æ—¶å€™å‘ç°ï¼Œå¤§éƒ¨åˆ†å…¬å¸éƒ½è¦æ±‚æŒæ¡reactæ‰å¯ä»¥ï¼Œä½†æ˜¯å¹³æ—¶è‡ªå·±ä¸»è¦ä½¿ç”¨çš„éƒ½æ˜¯vue3+tsè¿›è¡Œå¼€å‘çš„ï¼Œæ‰€ä»¥ç°åœ¨å°±æ¥å­¦ä¹ reactçš„ç›¸å…³çŸ¥è¯†å¹¶è¿›è¡Œä¸€äº›å°å†…å®¹çš„å¼€å‘ã€‚

## åˆè¯†jsx

åœ¨reactä¸­ï¼Œjsxçš„è½¬æ¢è§„åˆ™ä¼šåˆ†ä¸ºä»¥ä¸‹å‡ ç§ç±»å‹

```tsx
const toLearn = [ 'react' , 'vue' , 'webpack' , 'nodejs'  ]

const TextComponent = ()=> <div> hello , i am function component </div> 

class Index extends React.Component{
    status = false /* çŠ¶æ€ */
    renderFoot=()=> <div> i am foot</div>
    render(){
        /* ä»¥ä¸‹éƒ½æ˜¯å¸¸ç”¨çš„jsxå…ƒç´ èŠ‚ */
        return <div style={{ marginTop:'100px' }}   >
            { /* element å…ƒç´ ç±»å‹ */ }
            <div>hello,world</div>
            { /* fragment ç±»å‹ */ }
            <React.Fragment>
                <div> ğŸ‘½ğŸ‘½ </div>
            </React.Fragment>
            { /* text æ–‡æœ¬ç±»å‹ */ }
            my name is adsionli 
            { /* æ•°ç»„èŠ‚ç‚¹ç±»å‹ */ }
            { toLearn.map(item=> <div key={item} >let us learn { item } </div> ) }
            { /* ç»„ä»¶ç±»å‹ */ }
            <TextComponent/>
            { /* ä¸‰å…ƒè¿ç®— */  }
            { this.status ? <TextComponent /> : <div>ä¸‰å…ƒè¿ç®—</div> }
            { /* å‡½æ•°æ‰§è¡Œ */ } 
            { this.renderFoot() }
            <button onClick={ ()=> console.log( this.render() ) } >æ‰“å°renderåçš„å†…å®¹</button>
        </div>
    }
}
```

ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œä¸€å…±å±•ç¤ºäº†8ç§ç±»å‹ï¼šelementå…ƒç´ ç±»å‹ã€fragmentç±»å‹ï¼ˆreactå†…ç½®ç‰‡æ®µï¼‰ã€æ–‡æœ¬ç±»å‹ã€æ•°ç»„ç±»å‹ã€ç»„ä»¶ç±»å‹ã€ä¸‰å…ƒè¿ç®—ç±»å‹ã€å‡½æ•°æ‰§è¡Œç±»å‹ã€‚æ¯ä¸€ç§ç±»å‹éƒ½ä¼šåœ¨ç¼–è¯‘ä¹‹åï¼Œå˜ä¸ºReact Element å½¢å¼ã€‚è¿™é‡ŒReactä¼šè°ƒç”¨å‡½æ•°`React.createElement`æ¥è¿›è¡ŒèŠ‚ç‚¹çš„åˆ›å»ºï¼Œå®ƒä¸»è¦çš„ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ï¼š

1. ç¬¬ä¸€ä¸ªå‚æ•°ï¼šå¦‚æœæ˜¯ç»„ä»¶ç±»å‹ï¼Œä¼šä¼ å…¥ç»„ä»¶å¯¹åº”çš„ç±»æˆ–å‡½æ•°ï¼›å¦‚æœæ˜¯ dom å…ƒç´ ç±»å‹ï¼Œä¼ å…¥ div æˆ–è€… span ä¹‹ç±»çš„å­—ç¬¦ä¸²ã€‚
2. ç¬¬äºŒä¸ªå‚æ•°ï¼šä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨ dom ç±»å‹ä¸­ä¸ºæ ‡ç­¾å±æ€§ï¼Œåœ¨ç»„ä»¶ç±»å‹ä¸­ä¸º props ã€‚

å‡ºäº†ä¸Šè¿°çš„ä¸¤ä¸ªæœ€é‡è¦çš„å‚æ•°ä¹‹å¤–ï¼Œåé¢è¿˜å¯ä»¥ä¼ å…¥childrençš„å‚æ•°ã€‚

å¯ä»¥çœ‹ä¸€ä¸‹ä¸‹æ®µä»£ç :

```html
<div>
   <TextComponent />
   <div>hello,world</div>
   let us learn React!
</div>
```

ä¸Šæ®µä»£ç å°±ä¼šè¢«ç¼–è¯‘ä¸º:

```js
React.createElement("div", null,
                    React.createElement(TextComponent, null),
                    React.createElement("div", null, "hello,world"),
                    "let us learn React!"
                   )
```

çŸ¥é“äº†æ€ä¹ˆå›äº‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®°ä¸€ä¸‹jsxçš„è½¬æ¢è§„åˆ™ï¼Œè¿™æ ·æœ‰åŠ©äºæˆ‘ä»¬ä¹‹åæ›´åŠ ç†Ÿç»ƒçš„ä½¿ç”¨jsxçš„è¯­æ³•

| `jsx`å…ƒç´ ç±»å‹     | `react.createElement` è½¬æ¢å                      | `type` å±æ€§                   |
| ----------------- | ------------------------------------------------- | ----------------------------- |
| `element`å…ƒç´ ç±»å‹ | `react element`ç±»å‹                               | æ ‡ç­¾å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ `div`        |
| `fragment`ç±»å‹    | `react element`ç±»å‹                               | `symbol` `react.fragment`ç±»å‹ |
| æ–‡æœ¬ç±»å‹          | ç›´æ¥å­—ç¬¦ä¸²                                        | æ—                             |
| æ•°ç»„ç±»å‹          | è¿”å›æ•°ç»„ç»“æ„ï¼Œé‡Œé¢å…ƒç´ è¢«`react.createElement`è½¬æ¢ | æ—                             |
| ç»„ä»¶ç±»å‹          | `react element`ç±»å‹                               | ç»„ä»¶ç±»æˆ–è€…ç»„ä»¶å‡½æ•°æœ¬èº«        |
| ä¸‰å…ƒè¿ç®— / è¡¨è¾¾å¼ | å…ˆæ‰§è¡Œä¸‰å…ƒè¿ç®—ï¼Œç„¶åæŒ‰ç…§ä¸Šè¿°è§„åˆ™å¤„ç†              | çœ‹ä¸‰å…ƒè¿ç®—è¿”å›ç»“æœ            |
| å‡½æ•°æ‰§è¡Œ          | å…ˆæ‰§è¡Œå‡½æ•°ï¼Œç„¶åæŒ‰ç…§ä¸Šè¿°è§„åˆ™å¤„ç†                  | çœ‹å‡½æ•°æ‰§è¡Œè¿”å›ç»“æœ            |

### reactå¤„ç†

reactåœ¨é€šè¿‡å°†jsxè¯­æ³•è½¬æ¢æˆReact Elementä¹‹åï¼Œä¼šè¿›å…¥åˆ°è°ƒå’Œé˜¶æ®µï¼Œæ‰€è°“çš„è°ƒå’Œé˜¶æ®µå°±æ˜¯å°†React Elementè½¬æ¢æˆå¯¹åº”çš„fiberå¯¹è±¡ï¼Œç„¶åå°±åƒæ„å»ºåŸå‹é“¾ä¸€æ ·ï¼Œé€šè¿‡sibling,return,childå°†æ¯ä¸€ä¸ªfiberå¯¹è±¡è”ç³»èµ·æ¥ã€‚

#### fiberç±»å‹

åœ¨reactä¸­fiberä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸€äº›ç±»å‹:

```typescript
export const FunctionComponent = 0;       // å‡½æ•°ç»„ä»¶
export const ClassComponent = 1;          // ç±»ç»„ä»¶
export const IndeterminateComponent = 2;  // åˆå§‹åŒ–çš„æ—¶å€™ä¸çŸ¥é“æ˜¯å‡½æ•°ç»„ä»¶è¿˜æ˜¯ç±»ç»„ä»¶ 
export const HostRoot = 3;                // Root Fiber å¯ä»¥ç†è§£ä¸ºæ ¹å…ƒç´  ï¼Œ é€šè¿‡reactDom.render()äº§ç”Ÿçš„æ ¹å…ƒç´ 
export const HostPortal = 4;              // å¯¹åº”  ReactDOM.createPortal äº§ç”Ÿçš„ Portal 
export const HostComponent = 5;           // dom å…ƒç´  æ¯”å¦‚ <div>
export const HostText = 6;                // æ–‡æœ¬èŠ‚ç‚¹
export const Fragment = 7;                // å¯¹åº” <React.Fragment> 
export const Mode = 8;                    // å¯¹åº” <React.StrictMode>   
export const ContextConsumer = 9;         // å¯¹åº” <Context.Consumer>
export const ContextProvider = 10;        // å¯¹åº” <Context.Provider>
export const ForwardRef = 11;             // å¯¹åº” React.ForwardRef
export const Profiler = 12;               // å¯¹åº” <Profiler/ >
export const SuspenseComponent = 13;      // å¯¹åº” <Suspense>
export const MemoComponent = 14;          // å¯¹åº” React.memo è¿”å›çš„ç»„ä»¶
```

#### fiberç»“æ„

jsxæœ€ç»ˆä¼šæ ¹æ®è°ƒå’Œä¹‹åäº§ç”Ÿfiberå¯¹è±¡ï¼Œäº§ç”Ÿä¸€ä¸ªfiberç»“æ„å›¾ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

<img src="../../image/react/learning/01/jsx-fiber-relation.png" alt="jsx-fiber-relation.jpg" style="zoom:50%;" />

fiber å¯¹åº”å…³ç³»

- childï¼š ä¸€ä¸ªç”±çˆ¶çº§ fiber æŒ‡å‘å­çº§ fiber çš„æŒ‡é’ˆã€‚
- returnï¼šä¸€ä¸ªå­çº§ fiber æŒ‡å‘çˆ¶çº§ fiber çš„æŒ‡é’ˆã€‚
- sibling: ä¸€ä¸ª fiber æŒ‡å‘ä¸‹ä¸€ä¸ªå…„å¼Ÿ fiber çš„æŒ‡é’ˆã€‚

> æ•°ç»„ç»“æ„å¤–å±‚ä¼šè¢«åŠ ä¸Šä¸€å±‚fragmentï¼Œç„¶åå…¶ä¸­çš„æ•°ç»„å†…å®¹å›ä½œä¸ºfragmentçš„å­èŠ‚ç‚¹

### å¯æ§æ€§render

ä¸Šé¢çš„ demo æš´éœ²å‡ºäº†å¦‚ä¸‹é—®é¢˜ï¼š

1. è¿”å›çš„ `children` è™½ç„¶æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä½†æ˜¯æ•°ç»„é‡Œé¢çš„æ•°æ®ç±»å‹å´æ˜¯ä¸ç¡®å®šçš„ï¼Œæœ‰å¯¹è±¡ç±»å‹( å¦‚`ReactElement` ) ï¼Œæœ‰æ•°ç»„ç±»å‹(å¦‚ `map` éå†è¿”å›çš„å­èŠ‚ç‚¹)ï¼Œè¿˜æœ‰å­—ç¬¦ä¸²ç±»å‹(å¦‚æ–‡æœ¬)ï¼›
2. æ— æ³•å¯¹ render åçš„ React element å…ƒç´ è¿›è¡Œå¯æ§æ€§æ“ä½œã€‚

é’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¯¹demoé¡¹ç›®è¿›è¡Œæ”¹é€ å¤„ç†ï¼Œå…·ä½“è¿‡ç¨‹å¯ä»¥åˆ†ä¸º4æ­¥ï¼š

1. å°†ä¸Šè¿°children**æ‰å¹³åŒ–å¤„ç†**ï¼Œå°†æ•°ç»„ç±»å‹çš„å­èŠ‚ç‚¹æ‰“å¼€ ï¼›
2. **å¹²æ‰childrenä¸­æ–‡æœ¬ç±»å‹èŠ‚ç‚¹**ï¼›
3. å‘childrenæœ€åæ’å…¥say goodbyeå…ƒç´ ï¼›
4. å…‹éš†æ–°çš„å…ƒç´ èŠ‚ç‚¹å¹¶æ¸²æŸ“ã€‚

ç”±äºï¼Œæˆ‘ä»¬æƒ³è¦æŠŠ render è¿‡ç¨‹å˜æˆå¯æ§çš„ï¼Œå› æ­¤éœ€è¦æŠŠä¸Šè¿°ä»£ç è¿›è¡Œæ”¹é€ ã€‚

```jsx
class Index extends React.Component{
    status = false /* çŠ¶æ€ */
    renderFoot=()=> <div> i am foot</div>
    /* æ§åˆ¶æ¸²æŸ“ */
    controlRender=()=>{
        const reactElement = (
            <div style={{ marginTop:'100px' }} className="container"  >   
                 { /* element å…ƒç´ ç±»å‹ */ }
                <div>hello,world</div>  
                { /* fragment ç±»å‹ */ }
                <React.Fragment>      
                    <div> ğŸ‘½ğŸ‘½ </div>
                </React.Fragment>
                { /* text æ–‡æœ¬ç±»å‹ */ }
                my name is alien       
                { /* æ•°ç»„èŠ‚ç‚¹ç±»å‹ */ }
                { toLearn.map(item=> <div key={item} >let us learn { item } </div> ) } 
                { /* ç»„ä»¶ç±»å‹ */ }
                <TextComponent/>  
                { /* ä¸‰å…ƒè¿ç®— */  }
                { this.status ? <TextComponent /> :  <div>ä¸‰å…ƒè¿ç®—</div> }  
                { /* å‡½æ•°æ‰§è¡Œ */ } 
                { this.renderFoot() }  
                <button onClick={ ()=> console.log( this.render() ) } >æ‰“å°renderåçš„å†…å®¹</button>
            </div>
        )
        console.log(reactElement)
        const { children } = reactElement.props
        /* ç¬¬1æ­¥ ï¼š æ‰å¹³åŒ– children  */
        const flatChildren = React.Children.toArray(children)
        console.log(flatChildren)
        /* ç¬¬2æ­¥ ï¼š é™¤å»æ–‡æœ¬èŠ‚ç‚¹ */
        const newChildren :any= []
        React.Children.forEach(flatChildren,(item)=>{
            if(React.isValidElement(item)) newChildren.push(item)
        })
        /* ç¬¬3æ­¥ï¼Œæ’å…¥æ–°çš„èŠ‚ç‚¹ */
        const lastChildren = React.createElement(`div`,{ className :'last' } ,`say goodbye`)
        newChildren.push(lastChildren)
        
        /* ç¬¬4æ­¥ï¼šä¿®æ”¹å®¹å™¨èŠ‚ç‚¹ */
        const newReactElement =  React.cloneElement(reactElement,{} ,...newChildren )
        return newReactElement
    }
    render(){
        return this.controlRender()
    }
}
```

ç„¶åå°±å¯ä»¥ä¸€æ­¥ä¸€æ­¥è¿›è¡Œåˆ†æ

1. é¦–å…ˆæˆ‘ä»¬å°†`reactElement`ä¸­çš„`props`å±æ€§ä¸‹çš„`children`è¿›è¡Œè·å–ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°è¿™ä¸ª`React Element`ä¸‹çš„å…¨éƒ¨å­èŠ‚ç‚¹ã€‚

2. ç„¶åä½¿ç”¨`React.Children.toArray`è¿›è¡Œæ‰å¹³åŒ–å¤„ç†ã€‚

   > React.Children.toArray å¯ä»¥æ‰å¹³åŒ–ã€è§„èŒƒåŒ– React.element çš„ children ç»„æˆçš„æ•°ç»„ï¼Œåªè¦ children ä¸­çš„æ•°ç»„å…ƒç´ è¢«æ‰“å¼€ï¼Œå¯¹éå† children å¾ˆæœ‰å¸®åŠ©ï¼Œè€Œä¸” **React.Children.toArray è¿˜å¯ä»¥æ·±å±‚æ¬¡ flat** ã€‚

3. åœ¨ä½¿ç”¨`React.Children.forEach`å¯¹è·å–åˆ°çš„å­èŠ‚ç‚¹æ•°ç»„è¿›è¡Œéå†ï¼Œå¹¶åœ¨éå†ä¸­ä½¿ç”¨`React.isValidElement`å‡½æ•°åˆ¤æ–­å½“å‰`Element`æ˜¯ä¸æ˜¯ä¸€ä¸ª`React Element`å…ƒç´ ã€‚

   > `React.Children.forEach = React.Children.toArray + Array.prototype.forEach`
   >
   > React.Children.forEach æœ¬èº«å°±å¯ä»¥æŠŠ children æ‰å¹³åŒ–

4. ä½¿ç”¨`React.createElement`åˆ›å»ºæ–°çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ’å…¥åˆ°è¿‡æ»¤ä¹‹åçš„æ–°èŠ‚ç‚¹çš„æœ€å

5.  **å·²ç»ä¿®æ”¹äº† childrenï¼Œé€šè¿‡ cloneElement åˆ›å»ºæ–°çš„å®¹å™¨å…ƒç´ **

   > ä½¿ç”¨`React.cloneElement`æ˜¯ä¸ºäº†å°†elementå…ƒç´ ä¸ºæ ·æ¿cloneå¹¶è¿”å›æ–°çš„react elementå…ƒç´ ã€‚è¿”å›çš„å…ƒç´ çš„propsæ˜¯å°†æ–°çš„propsä¸åŸå§‹å…ƒç´ çš„propsè¿›è¡Œæµ…å±‚åˆå¹¶ä¹‹åçš„ç»“æœ
   >
   > `React.createElement`ä¸`React.cloneElement`ä¸åŒåœ°æ–¹åœ¨äº`createElement` æŠŠä¸Šé¢å†™çš„ jsxï¼Œå˜æˆ element å¯¹è±¡

é—®: React.createElement å’Œ React.cloneElement åˆ°åº•æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢?

ç­”: å¯ä»¥å®Œå…¨ç†è§£ä¸ºï¼Œä¸€ä¸ªæ˜¯ç”¨æ¥åˆ›å»º element ã€‚å¦ä¸€ä¸ªæ˜¯ç”¨æ¥ä¿®æ”¹ elementï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ React.element å¯¹è±¡ã€‚

### Babelè§£æjsxæµç¨‹

å¯¹äºjsxçš„è§£æï¼Œå…¶ä¸»è¦æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™é€šè¿‡babelå¯¹jsxè¯­æ³•è¿›è¡Œè§£æï¼Œè§£ææˆå¯è¢«æµè§ˆå™¨è®¤è¯†çš„jsä»£ç ï¼Œå…¶ä¸»è¦ä½¿ç”¨çš„ä¸¤ä¸ªbabelçš„pluginæ˜¯ï¼š

- @babel/plugin-syntax-jsx ï¼š ä½¿ç”¨è¿™ä¸ªæ’ä»¶ï¼Œèƒ½å¤Ÿè®© Babel æœ‰æ•ˆçš„è§£æ JSX è¯­æ³•ã€‚
- @babel/plugin-transform-react-jsx ï¼šè¿™ä¸ªæ’ä»¶å†…éƒ¨è°ƒç”¨äº† @babel/plugin-syntax-jsxï¼Œå¯ä»¥æŠŠ React JSX è½¬åŒ–æˆ JS èƒ½å¤Ÿè¯†åˆ«çš„ createElement æ ¼å¼ã€‚

æ–°ç‰ˆæœ¬ React å·²ç»ä¸éœ€è¦å¼•å…¥ createElement ï¼Œè¿™ç§æ¨¡å¼æ¥æºäº `Automatic Runtime`ï¼Œçœ‹ä¸€ä¸‹æ˜¯å¦‚ä½•ç¼–è¯‘çš„ã€‚

ä¸šåŠ¡ä»£ç ä¸­å†™çš„ JSX æ–‡ä»¶ï¼š

```js
function Index(){
    return <div>
        <h1>hello,world</h1>
        <span>let us learn React</span>
    </div>
}
```

è¢«ç¼–è¯‘åçš„æ–‡ä»¶ï¼š

```js
import { jsx as _jsx } from "react/jsx-runtime";
import { jsxs as _jsxs } from "react/jsx-runtime";
function Index() {
  return  _jsxs("div", {
            children: [
                _jsx("h1", {
                   children: "hello,world"
                }),
                _jsx("span", {
                    children:"let us learn React" ,
                }),
            ],
        });
}
```

plugin-syntax-jsx å·²ç»å‘æ–‡ä»¶ä¸­æå‰æ³¨å…¥äº† _jsxRuntime apiã€‚ä¸è¿‡è¿™ç§æ¨¡å¼ä¸‹éœ€è¦æˆ‘ä»¬åœ¨ .babelrc è®¾ç½® runtime: automatic ã€‚

```json
"presets": [    
    ["@babel/preset-react",{
    "runtime": "automatic"
    }]     
],
```

#### apiå±‚é¢æ¨¡æ‹Ÿå®ç°jsxè§£ææµç¨‹

ç¬¬ä¸€æ­¥ï¼šåˆ›å»º element.jsï¼Œå†™ä¸‹å°†æµ‹è¯•çš„ JSX ä»£ç ã€‚

```js
import React from 'react'

function TestComponent(){
    return <p> hello,React </p>
}
function Index(){
    return <div>
        <span>æ¨¡æ‹Ÿ babel å¤„ç† jsx æµç¨‹ã€‚</span>
        <TestComponent />
    </div>
}
export default Index
```

ç¬¬äºŒæ­¥ï¼šå› ä¸º babel è¿è¡Œåœ¨ node ç¯å¢ƒï¼Œæ‰€ä»¥åŒçº§ç›®å½•ä¸‹åˆ›å»º jsx.js æ–‡ä»¶ã€‚æ¥æ¨¡æ‹Ÿä¸€ä¸‹ç¼–è¯‘çš„æ•ˆæœã€‚

```js
const fs = require('fs')
const babel = require("@babel/core")

/* ç¬¬ä¸€æ­¥ï¼šæ¨¡æ‹Ÿè¯»å–æ–‡ä»¶å†…å®¹ã€‚ */
fs.readFile('./element.js',(e,data)=>{ 
    const code = data.toString('utf-8')
    /* ç¬¬äºŒæ­¥ï¼šè½¬æ¢ jsx æ–‡ä»¶ */
    const result = babel.transformSync(code, {
        plugins: ["@babel/plugin-transform-react-jsx"],
    });
    /* ç¬¬ä¸‰æ­¥ï¼šæ¨¡æ‹Ÿé‡æ–°å†™å…¥å†…å®¹ã€‚ */
    fs.writeFile('./element.js',result.code,function(){})
})
```

å¦‚ä¸Šç»è¿‡ä¸‰æ­¥å¤„ç†ä¹‹åï¼Œå†æ¥çœ‹ä¸€ä¸‹ element.js å˜æˆäº†ä»€ä¹ˆæ ·å­ã€‚

```js
import React from 'react';

function TestComponent() {
  return /*#__PURE__*/React.createElement("p", null, " hello,React ");
}

function Index() {
  return /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", null, "\u6A21\u62DF babel \u5904\u7406 jsx \u6D41\u7A0B\u3002"), /*#__PURE__*/React.createElement(TestComponent, null));
}
export default Index;
```

å¦‚ä¸Šå¯ä»¥çœ‹åˆ°å·²ç»æˆåŠŸè½¬æˆ React.createElement å½¢å¼ï¼Œä»æ ¹æœ¬ä¸Šå¼„æ¸…æ¥šäº† Babel è§£æ JSX çš„å¤§è‡´æµç¨‹ã€‚

## Component

åœ¨reactä¸­ï¼Œå…¶æ•´ä¸ªæ¡†æ¶ç»„æˆå°±æ˜¯æœ‰å„ç§Componentè¿›è¡Œç»„åˆè€Œæˆï¼Œå…¶ä¸»è¦åˆ†ä¸ºä¸¤ç§ç»„ä»¶å½¢å¼ï¼Œåˆ†åˆ«æ˜¯ç±»ç»„ä»¶ä¸å‡½æ•°ç»„ä»¶ï¼Œé‚£ä¹ˆç±»ç»„ä»¶å’Œå‡½æ•°ç»„ä»¶ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿå¯ä»¥çœ‹ä¸€ä¸‹ä¸‹é¢çš„ä»£ç 

```js
/* ç±» */
class textClass {
    sayHello=()=>console.log('hello, my name is alien')
}
/* ç±»ç»„ä»¶ */
class Index extends React.Component{
    state={ message:`hello ï¼Œworld!` }
    sayHello=()=> this.setState({ message : 'hello, my name is alien' })
    render(){
        return <div style={{ marginTop:'50px' }} onClick={ this.sayHello } > { this.state.message }  </div>
    }
}
/* å‡½æ•° */
function textFun (){ 
    return 'hello, world'
}
/* å‡½æ•°ç»„ä»¶ */
function FunComponent(){
    const [ message , setMessage ] = useState('hello,world')
    return <div onClick={ ()=> setMessage('hello, my name is alien')  } >{ message }</div>
}
```

ç»„ä»¶æœ¬è´¨ä¸Šå°±æ˜¯ç±»å’Œå‡½æ•°ï¼Œä½†æ˜¯ä¸å¸¸è§„çš„ç±»å’Œå‡½æ•°ä¸åŒçš„æ˜¯ï¼Œ**ç»„ä»¶æ‰¿è½½äº†æ¸²æŸ“è§†å›¾çš„ UI å’Œæ›´æ–°è§†å›¾çš„ `setState` ã€ `useState` ç­‰æ–¹æ³•**ã€‚React åœ¨åº•å±‚é€»è¾‘ä¸Šä¼šåƒæ­£å¸¸å®ä¾‹åŒ–ç±»å’Œæ­£å¸¸æ‰§è¡Œå‡½æ•°é‚£æ ·å¤„ç†çš„ç»„ä»¶ã€‚

> ç»„ä»¶å°±æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªç«‹å³æ‰§è¡Œå‡½æ•°

### Reactç»„ä»¶å¤„ç†æµç¨‹

ç±»ç»„ä»¶æ‰§è¡Œæ–¹å¼

> å¯¹äºç±»ç»„ä»¶çš„æ‰§è¡Œï¼Œæ˜¯åœ¨react-reconciler/src/ReactFiberClassComponent.jsä¸­

```js
function constructClassInstance(
    workInProgress, // å½“å‰æ­£åœ¨å·¥ä½œçš„ fiber å¯¹è±¡
    ctor,           // æˆ‘ä»¬çš„ç±»ç»„ä»¶
    props           // props 
){
     /* å®ä¾‹åŒ–ç»„ä»¶ï¼Œå¾—åˆ°ç»„ä»¶å®ä¾‹ instance */
     const instance = new ctor(props, context)
}
```

å‡½æ•°ç»„ä»¶æ‰§è¡Œæ–¹å¼

> å¯¹äºå‡½æ•°ç»„ä»¶çš„æ‰§è¡Œï¼Œæ˜¯åœ¨react-reconciler/src/ReactFiberHooks.jsä¸­

```js
function renderWithHooks(
  current,          // å½“å‰å‡½æ•°ç»„ä»¶å¯¹åº”çš„ `fiber`ï¼Œ åˆå§‹åŒ–
  workInProgress,   // å½“å‰æ­£åœ¨å·¥ä½œçš„ fiber å¯¹è±¡
  Component,        // æˆ‘ä»¬å‡½æ•°ç»„ä»¶
  props,            // å‡½æ•°ç»„ä»¶ç¬¬ä¸€ä¸ªå‚æ•° props
  secondArg,        // å‡½æ•°ç»„ä»¶å…¶ä»–å‚æ•°
  nextRenderExpirationTime, //ä¸‹æ¬¡æ¸²æŸ“è¿‡æœŸæ—¶é—´
){
     /* æ‰§è¡Œæˆ‘ä»¬çš„å‡½æ•°ç»„ä»¶ï¼Œå¾—åˆ° return è¿”å›çš„ React.elementå¯¹è±¡ */
     let children = Component(props, secondArg);
}
```

å…¶å®ä¸éš¾çœ‹å‡ºï¼Œå¯¹äºç±»ç»„ä»¶æ¥è¯´ï¼Œå®é™…å°±æ˜¯è¿›è¡Œä¸€ä¸ªå®ä¾‹åŒ–è¿‡ç¨‹ï¼›å¯¹äºå‡½æ•°ç»„ä»¶æ¥è¯´ï¼Œåˆ™æ˜¯ä¸€ä¸ªæ‰§è¡Œè¿‡ç¨‹ã€‚

åœ¨ React è°ƒå’Œæ¸²æŸ“ fiber èŠ‚ç‚¹çš„æ—¶å€™ï¼Œ**å¦‚æœå‘ç° fiber tag æ˜¯ ClassComponent = 1ï¼Œåˆ™æŒ‰ç…§ç±»ç»„ä»¶é€»è¾‘å¤„ç†ï¼Œå¦‚æœæ˜¯ FunctionComponent = 0 åˆ™æŒ‰ç…§å‡½æ•°ç»„ä»¶é€»è¾‘å¤„ç†**ã€‚å½“ç„¶ React ä¹Ÿæä¾›äº†ä¸€äº›å†…ç½®çš„ç»„ä»¶ï¼Œæ¯”å¦‚è¯´ Suspense ã€Profiler ç­‰ã€‚

> é€šè¿‡åˆ¤æ–­fiber tagçš„ç±»å‹ï¼Œå…·ä½“çš„åˆ†ç±»å¯ä»¥çœ‹ä¸Šä¸€è®²ã€‚

### ä¸¤ç§ä¸åŒçš„Reactç»„ä»¶

#### 1. ç±»ç»„ä»¶

åœ¨ class ç»„ä»¶ä¸­ï¼Œé™¤äº†ç»§æ‰¿ React.Component ï¼Œåº•å±‚è¿˜åŠ å…¥äº† updater å¯¹è±¡ï¼Œç»„ä»¶ä¸­è°ƒç”¨çš„ `setState` å’Œ `forceUpdate` æœ¬è´¨ä¸Šæ˜¯è°ƒç”¨äº† `updater` å¯¹è±¡ä¸Šçš„ `enqueueSetState` å’Œ `enqueueForceUpdate` æ–¹æ³•ã€‚

React åº•å±‚æ˜¯å¦‚ä½•å®šä¹‰ç±»ç»„ä»¶çš„å‘¢ï¼Ÿ

> æºç ä½ç½®ï¼šreact/src/ReactBaseClasses.js

```js
function Component(props, context, updater) {
  this.props = props;      //ç»‘å®šprops
  this.context = context;  //ç»‘å®šcontext
  this.refs = emptyObject; //ç»‘å®šref
  this.updater = updater || ReactNoopUpdateQueue; //ä¸Šé¢æ‰€å±çš„updater å¯¹è±¡
}
/* ç»‘å®šsetState æ–¹æ³• */
Component.prototype.setState = function(partialState, callback) {
  this.updater.enqueueSetState(this, partialState, callback, 'setState');
}
/* ç»‘å®šforceupdate æ–¹æ³• */
Component.prototype.forceUpdate = function(callback) {
  this.updater.enqueueForceUpdate(this, callback, 'forceUpdate');
}
```

å¦‚ä¸Šå¯ä»¥çœ‹å‡º `Component` åº•å±‚ `React` çš„å¤„ç†é€»è¾‘æ˜¯ï¼šç±»ç»„ä»¶æ‰§è¡Œæ„é€ å‡½æ•°è¿‡ç¨‹ä¸­ä¼šåœ¨å®ä¾‹ä¸Šç»‘å®š `props` å’Œ `context` ï¼Œåˆå§‹åŒ–ç½®ç©º refs å±æ€§ï¼ŒåŸå‹é“¾ä¸Šç»‘å®š`setState`ã€`forceUpdate` æ–¹æ³•ã€‚å¯¹äº `updater`ï¼ŒReact åœ¨å®ä¾‹åŒ–ç±»ç»„ä»¶ä¹‹åä¼šå•ç‹¬ç»‘å®š `update` å¯¹è±¡ã€‚

**ï½œ--------é—®ä¸ç­”---------ï½œ**

é—®ï¼šå¦‚æœæ²¡æœ‰åœ¨ constructor çš„ super å‡½æ•°ä¸­ä¼ é€’ propsï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ constructor æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­å°±è·å–ä¸åˆ° props ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

```js
/* å‡è®¾æˆ‘ä»¬åœ¨ constructor ä¸­è¿™ä¹ˆå†™ */
constructor(){
    super()
    console.log(this.props) // æ‰“å° undefined ä¸ºä»€ä¹ˆ?
}
```

ç­”æ¡ˆå¾ˆç®€å•ï¼Œåˆšæ‰çš„ Component æºç å·²ç»è¯´å¾—æ˜æ˜ç™½ç™½äº†ï¼Œç»‘å®š props æ˜¯åœ¨çˆ¶ç±» Component æ„é€ å‡½æ•°ä¸­ï¼Œæ‰§è¡Œ super ç­‰äºæ‰§è¡Œ Component å‡½æ•°ï¼Œæ­¤æ—¶ props æ²¡æœ‰ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ ç»™ super() ï¼Œåœ¨ Component ä¸­å°±ä¼šæ‰¾ä¸åˆ° props å‚æ•°ï¼Œä»è€Œå˜æˆ undefined ï¼Œåœ¨æ¥ä¸‹æ¥ constructor ä»£ç ä¸­æ‰“å° props ä¸º undefined ã€‚

```js
/* è§£å†³é—®é¢˜ */
constructor(props){ 
    super(props)
}
```

**ï½œ---------end----------ï½œ**

**ä¸ºäº†æ›´å¥½åœ°ä½¿ç”¨ React ç±»ç»„ä»¶ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹ç±»ç»„ä»¶å„ä¸ªéƒ¨åˆ†çš„åŠŸèƒ½ï¼š**

```js
class Index extends React.Component{
    constructor(...arg){
       super(...arg)                        /* æ‰§è¡Œ react åº•å±‚ Component å‡½æ•° */
    }
    state = {}                              /* state */
    static number = 1                       /* å†…ç½®é™æ€å±æ€§ */
    handleClick= () => console.log(111)     /* æ–¹æ³•ï¼š ç®­å¤´å‡½æ•°æ–¹æ³•ç›´æ¥ç»‘å®šåœ¨thiså®ä¾‹ä¸Š */
    componentDidMount(){                    /* ç”Ÿå‘½å‘¨æœŸ */
        console.log(Index.number,Index.number1) // æ‰“å° 1 , 2 
    }
    render(){                               /* æ¸²æŸ“å‡½æ•° */
        return <div style={{ marginTop:'50px' }} onClick={ this.handerClick }  >hello,React!</div>
    }
}
Index.number1 = 2                           /* å¤–ç½®é™æ€å±æ€§ */
Index.prototype.handleClick = ()=> console.log(222) /* æ–¹æ³•: ç»‘å®šåœ¨ Index åŸå‹é“¾çš„ æ–¹æ³•*/
```

ä¸Šé¢æŠŠç±»ç»„ä»¶çš„ä¸»è¦ç»„æˆéƒ¨åˆ†éƒ½å±•ç¤ºç»™å¤§å®¶äº†ã€‚é’ˆå¯¹ state ï¼Œç”Ÿå‘½å‘¨æœŸç­‰éƒ¨åˆ†ï¼Œåç»­ä¼šæœ‰ä¸“é—¨çš„ç« èŠ‚è¿›è¡Œè®²è§£ã€‚

**ï½œ--------é—®ä¸ç­”---------ï½œ**

é—®ï¼šä¸Šè¿°ç»‘å®šäº†ä¸¤ä¸ª handleClick ï¼Œé‚£ä¹ˆç‚¹å‡» div ä¹‹åä¼šæ‰“å°ä»€ä¹ˆå‘¢ï¼Ÿ

ç­”ï¼šç»“æœæ˜¯ 111 ã€‚å› ä¸ºåœ¨ class ç±»å†…éƒ¨ï¼Œç®­å¤´å‡½æ•°æ˜¯ç›´æ¥ç»‘å®šåœ¨å®ä¾‹å¯¹è±¡ä¸Šçš„ï¼Œè€Œç¬¬äºŒä¸ª handleClick æ˜¯ç»‘å®šåœ¨ prototype åŸå‹é“¾ä¸Šçš„ï¼Œå®ƒä»¬çš„ä¼˜å…ˆçº§æ˜¯ï¼šå®ä¾‹å¯¹è±¡ä¸Šæ–¹æ³•å±æ€§ > åŸå‹é“¾å¯¹è±¡ä¸Šæ–¹æ³•å±æ€§ã€‚

**ï½œ---------end----------ï½œ**



> è®°å½•ï¼š
>
> 1. å¯¹äºç±»ç»„ä»¶æ¥è¯´ï¼Œå…¶ä¸Šçš„propsã€contextã€updateréƒ½éœ€è¦åœ¨constructorä¸­é€šè¿‡superä¼ ç»™Componentå¯¹è±¡ï¼Œåªæœ‰è¿™æ ·æ‰èƒ½é€šè¿‡thisæ¥ä½¿ç”¨props
>
> 2. å¯¹äºComponentä¸‹çš„`setState`ä¸`forceupdater`æ¥è¯´ï¼Œå…¶æœ¬è´¨æ˜¯è°ƒç”¨React.updaterå¯¹è±¡ä¸‹çš„`enqueueSetState`ï¼Œ`enqueueForceUpdate`

#### 2. å‡½æ•°ç»„ä»¶

**ReactV16.8** hooks é—®ä¸–ä»¥æ¥ï¼Œå¯¹å‡½æ•°ç»„ä»¶çš„åŠŸèƒ½åŠ ä»¥å¼ºåŒ–ï¼Œå¯ä»¥åœ¨ function ç»„ä»¶ä¸­ï¼Œåšç±»ç»„ä»¶ä¸€åˆ‡èƒ½åšçš„äº‹æƒ…ï¼Œç”šè‡³å®Œå…¨å–ç¼”ç±»ç»„ä»¶ã€‚**å‡½æ•°ç»„ä»¶çš„ç»“æ„ç›¸æ¯”ç±»ç»„ä»¶å°±ç®€å•å¤šäº†**ï¼Œæ¯”å¦‚è¯´ï¼Œä¸‹é¢å†™äº†ä¸€ä¸ªå¸¸è§„çš„å‡½æ•°ç»„ä»¶ï¼š

```js
function Index(){
    console.log(Index.number) // æ‰“å° 1 
    const [ message , setMessage  ] = useState('hello,world') /* hooks  */
    return <div onClick={() => setMessage('let us learn React!')  } > { message } </div> /* è¿”å›å€¼ ä½œä¸ºæ¸²æŸ“ui */
 }
 Index.number = 1 /* ç»‘å®šé™æ€å±æ€§ */
```

> æ³¨æ„ï¼šä¸è¦å°è¯•ç»™å‡½æ•°ç»„ä»¶ prototype ç»‘å®šå±æ€§æˆ–æ–¹æ³•ï¼Œå³ä½¿ç»‘å®šäº†ä¹Ÿæ²¡æœ‰ä»»ä½•ä½œç”¨ï¼Œå› ä¸ºé€šè¿‡ä¸Šé¢æºç ä¸­ React å¯¹å‡½æ•°ç»„ä»¶çš„è°ƒç”¨ï¼Œ**æ˜¯é‡‡ç”¨ç›´æ¥æ‰§è¡Œå‡½æ•°çš„æ–¹å¼ï¼Œè€Œä¸æ˜¯é€šè¿‡newçš„æ–¹å¼**ã€‚

é‚£ä¹ˆï¼Œå‡½æ•°ç»„ä»¶å’Œç±»ç»„ä»¶æœ¬è´¨çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

**å¯¹äºç±»ç»„ä»¶æ¥è¯´ï¼Œåº•å±‚åªéœ€è¦å®ä¾‹åŒ–ä¸€æ¬¡ï¼Œå®ä¾‹ä¸­ä¿å­˜äº†ç»„ä»¶çš„ state ç­‰çŠ¶æ€ã€‚å¯¹äºæ¯ä¸€æ¬¡æ›´æ–°åªéœ€è¦è°ƒç”¨ render æ–¹æ³•ä»¥åŠå¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸå°±å¯ä»¥äº†ã€‚ä½†æ˜¯åœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œæ¯ä¸€æ¬¡æ›´æ–°éƒ½æ˜¯ä¸€æ¬¡æ–°çš„å‡½æ•°æ‰§è¡Œï¼Œä¸€æ¬¡å‡½æ•°ç»„ä»¶çš„æ›´æ–°ï¼Œé‡Œé¢çš„å˜é‡ä¼šé‡æ–°å£°æ˜ã€‚**

> å¯¹äºç±»ç»„ä»¶æ¥è¯´ï¼Œæ›´æ–°å¹¶ä¸ä¼šé‡æ–°newï¼Œè€Œæ˜¯ä¼šè§¦å‘å“åº”çš„ç”Ÿå‘½å‘¨æœŸï¼Œä½†æ˜¯å¯¹äºå‡½æ•°ç»„ä»¶æ¥è¯´ï¼Œæ¯ä¸€æ¬¡æ›´æ–°éƒ½ä¼šé‡æ–°æ‰§è¡Œ
>
> ä¹Ÿå°±æ˜¯è¯´æ›´æ–°çš„æ¨¡å¼ä¸åŒ

ä¸ºäº†èƒ½è®©å‡½æ•°ç»„ä»¶å¯ä»¥ä¿å­˜ä¸€äº›çŠ¶æ€ï¼Œæ‰§è¡Œä¸€äº›å‰¯ä½œç”¨é’©å­ï¼ŒReact Hooks åº”è¿è€Œç”Ÿï¼Œå®ƒå¯ä»¥å¸®åŠ©è®°å½• React ä¸­ç»„ä»¶çš„çŠ¶æ€ï¼Œå¤„ç†ä¸€äº›é¢å¤–çš„å‰¯ä½œç”¨ã€‚

### çˆ¶å­ç»„ä»¶é€šä¿¡

React ä¸€å…±æœ‰ 5 ç§ä¸»æµçš„é€šä¿¡æ–¹å¼ï¼š

1. props å’Œ callback æ–¹å¼
2. ref æ–¹å¼ã€‚
3. React-redux æˆ– React-mobx çŠ¶æ€ç®¡ç†æ–¹å¼ã€‚
4. context ä¸Šä¸‹æ–‡æ–¹å¼ã€‚
5. event bus äº‹ä»¶æ€»çº¿ã€‚

**â‘  props å’Œ callback æ–¹å¼**

props å’Œ callback å¯ä»¥ä½œä¸º React ç»„ä»¶æœ€åŸºæœ¬çš„é€šä¿¡æ–¹å¼ï¼Œçˆ¶ç»„ä»¶å¯ä»¥é€šè¿‡ props å°†ä¿¡æ¯ä¼ é€’ç»™å­ç»„ä»¶ï¼Œå­ç»„ä»¶å¯ä»¥é€šè¿‡æ‰§è¡Œ props ä¸­çš„å›è°ƒå‡½æ•° callback æ¥è§¦å‘çˆ¶ç»„ä»¶çš„æ–¹æ³•ï¼Œå®ç°çˆ¶ä¸å­çš„æ¶ˆæ¯é€šè®¯ã€‚

çˆ¶ç»„ä»¶ -> é€šè¿‡è‡ªèº« state æ”¹å˜ï¼Œé‡æ–°æ¸²æŸ“ï¼Œä¼ é€’ props -> é€šçŸ¥å­ç»„ä»¶

å­ç»„ä»¶ -> é€šè¿‡è°ƒç”¨çˆ¶ç»„ä»¶ props æ–¹æ³• -> é€šçŸ¥çˆ¶ç»„ä»¶ã€‚

```js
/* å­ç»„ä»¶ */
function Son(props){
    const {  fatherSay , sayFather  } = props
    return <div className='son' >
         æˆ‘æ˜¯å­ç»„ä»¶
        <div> çˆ¶ç»„ä»¶å¯¹æˆ‘è¯´ï¼š{ fatherSay } </div>
        <input placeholder="æˆ‘å¯¹çˆ¶ç»„ä»¶è¯´" onChange={ (e)=>sayFather(e.target.value) }   />
    </div>
}
/* çˆ¶ç»„ä»¶ */
function Father(){
    const [ childSay , setChildSay ] = useState('')
    const [ fatherSay , setFatherSay ] = useState('')
    return <div className="box father" >
        æˆ‘æ˜¯çˆ¶ç»„ä»¶
       <div> å­ç»„ä»¶å¯¹æˆ‘è¯´ï¼š{ childSay } </div>
       <input placeholder="æˆ‘å¯¹å­ç»„ä»¶è¯´" onChange={ (e)=>setFatherSay(e.target.value) }   />
       <Son fatherSay={fatherSay}  sayFather={ setChildSay }  />
    </div>
}
```

**æ•ˆæœ**

<img src="../../image/react/learning/01/props_callback.png" alt="comp0.gif" style="zoom:33%;" />

**â‘¤event busäº‹ä»¶æ€»çº¿**

å½“ç„¶åˆ©ç”¨ eventBus ä¹Ÿå¯ä»¥å®ç°ç»„ä»¶é€šä¿¡ï¼Œä½†æ˜¯åœ¨ React ä¸­å¹¶ä¸æå€¡ç”¨è¿™ç§æ–¹å¼ï¼Œæˆ‘è¿˜æ˜¯æ›´æå€¡ç”¨ props æ–¹å¼é€šä¿¡ã€‚å¦‚æœè¯´éè¦ç”¨ eventBusï¼Œæˆ‘è§‰å¾—å®ƒæ›´é€‚åˆç”¨ React åšåŸºç¡€æ„å»ºçš„å°ç¨‹åºï¼Œæ¯”å¦‚ Taroã€‚æ¥ä¸‹æ¥å°†ä¸Šè¿° demo é€šè¿‡ eventBus æ–¹å¼è¿›è¡Œæ”¹é€ ã€‚

```js
import { BusService } from './eventBus'
/* event Bus  */
function Son(){
    const [ fatherSay , setFatherSay ] = useState('')
    React.useEffect(()=>{ 
        BusService.on('fatherSay',(value)=>{  /* äº‹ä»¶ç»‘å®š , ç»™çˆ¶ç»„ä»¶ç»‘å®šäº‹ä»¶ */
            setFatherSay(value)
       })
       return function(){  BusService.off('fatherSay') /* è§£ç»‘äº‹ä»¶ */ }
    },[])
    return <div className='son' >
         æˆ‘æ˜¯å­ç»„ä»¶
        <div> çˆ¶ç»„ä»¶å¯¹æˆ‘è¯´ï¼š{ fatherSay } </div>
        <input placeholder="æˆ‘å¯¹çˆ¶ç»„ä»¶è¯´" onChange={ (e)=> BusService.emit('childSay',e.target.value)  }   />
    </div>
}
/* çˆ¶ç»„ä»¶ */
function Father(){
    const [ childSay , setChildSay ] = useState('')
    React.useEffect(()=>{    /* äº‹ä»¶ç»‘å®š , ç»™å­ç»„ä»¶ç»‘å®šäº‹ä»¶ */
        BusService.on('childSay',(value)=>{
             setChildSay(value)
        })
        return function(){  BusService.off('childSay') /* è§£ç»‘äº‹ä»¶ */ }
    },[])
    return <div className="box father" >
        æˆ‘æ˜¯çˆ¶ç»„ä»¶
       <div> å­ç»„ä»¶å¯¹æˆ‘è¯´ï¼š{ childSay } </div>
       <input placeholder="æˆ‘å¯¹å­ç»„ä»¶è¯´" onChange={ (e)=> BusService.emit('fatherSay',e.target.value) }   />
       <Son  />
    </div>
}
```

è¿™æ ·åšä¸ä»…è¾¾åˆ°äº†å’Œä½¿ç”¨ props åŒæ ·çš„æ•ˆæœï¼Œè¿˜èƒ½è·¨å±‚çº§ï¼Œä¸ä¼šå—åˆ° React çˆ¶å­ç»„ä»¶å±‚çº§çš„å½±å“ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆå¾ˆå¤šäººéƒ½ä¸æ¨èè¿™ç§æ–¹å¼å‘¢ï¼Ÿå› ä¸ºå®ƒæœ‰ä¸€äº›è‡´å‘½ç¼ºç‚¹ã€‚

- éœ€è¦æ‰‹åŠ¨ç»‘å®šå’Œè§£ç»‘ã€‚
- å¯¹äºå°å‹é¡¹ç›®è¿˜å¥½ï¼Œä½†æ˜¯å¯¹äºä¸­å¤§å‹é¡¹ç›®ï¼Œè¿™ç§æ–¹å¼çš„ç»„ä»¶é€šä¿¡ï¼Œä¼šé€ æˆç‰µä¸€å‘åŠ¨å…¨èº«çš„å½±å“ï¼Œè€Œä¸”åæœŸéš¾ä»¥ç»´æŠ¤ï¼Œç»„ä»¶ä¹‹é—´çš„çŠ¶æ€ä¹Ÿæ˜¯æœªçŸ¥çš„ã€‚
- ä¸€å®šç¨‹åº¦ä¸Šè¿èƒŒäº† React æ•°æ®æµå‘åŸåˆ™ã€‚

## ç»„ä»¶çš„å¼ºåŒ–æ–¹å¼

#### ç±»ç»„ä»¶ç»§æ‰¿

å¯¹äºç±»ç»„ä»¶çš„å¼ºåŒ–ï¼Œé¦–å…ˆæƒ³åˆ°çš„æ˜¯ç»§æ‰¿æ–¹å¼ï¼Œä¹‹å‰å¼€å‘çš„å¼€æºé¡¹ç›® react-keepalive-router å°±æ˜¯é€šè¿‡ç»§æ‰¿ React-Router ä¸­çš„ Switch å’Œ Router ï¼Œæ¥è¾¾åˆ°ç¼“å­˜é¡µé¢çš„åŠŸèƒ½çš„ã€‚å› ä¸º React ä¸­ç±»ç»„ä»¶ï¼Œæœ‰è‰¯å¥½çš„ç»§æ‰¿å±æ€§ï¼Œæ‰€ä»¥å¯ä»¥é’ˆå¯¹ä¸€äº›åŸºç¡€ç»„ä»¶ï¼Œé¦–å…ˆå®ç°ä¸€éƒ¨åˆ†åŸºç¡€åŠŸèƒ½ï¼Œå†é’ˆå¯¹é¡¹ç›®è¦æ±‚è¿›è¡Œæœ‰æ–¹å‘çš„**æ”¹é€ **ã€**å¼ºåŒ–**ã€**æ·»åŠ é¢å¤–åŠŸèƒ½**ã€‚

åŸºç¡€ç»„ä»¶ï¼š

```js
/* äººç±» */
class Person extends React.Component{
    constructor(props){
        super(props)
        console.log('hello , i am person')
    }
    componentDidMount(){ console.log(1111)  }
    eat(){    /* åƒé¥­ */ }
    sleep(){  /* ç¡è§‰ */  }
    ddd(){   console.log('æ‰“è±†è±†')  /* æ‰“è±†è±† */ }
    render(){
        return <div>
            å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯ä¸€ä¸ªperson
        </div>
    }
}
/* ç¨‹åºå‘˜ */
class Programmer extends Person{
    constructor(props){
        super(props)
        console.log('hello , i am Programmer too')
    }
    componentDidMount(){  console.log(this)  }
    code(){ /* æ•²ä»£ç  */ }
    render(){
        return <div style={ { marginTop:'50px' } } >
            { super.render() } { /* è®© Person ä¸­çš„ render æ‰§è¡Œ */ }
            æˆ‘è¿˜æ˜¯ä¸€ä¸ªç¨‹åºå‘˜ï¼    { /* æ·»åŠ è‡ªå·±çš„å†…å®¹ */ }
        </div>
    }
}
export default Programmer
```

æ•ˆæœï¼š

![comp1.jpg](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e0e33a65fdce428294b6432ac8050f54~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

æˆ‘ä»¬ä»ä¸Šé¢ä¸éš¾å‘ç°è¿™ä¸ªç»§æ‰¿å¢å¼ºæ•ˆæœå¾ˆä¼˜ç§€ã€‚å®ƒçš„ä¼˜åŠ¿å¦‚ä¸‹ï¼š

1. å¯ä»¥æ§åˆ¶çˆ¶ç±» renderï¼Œè¿˜å¯ä»¥æ·»åŠ ä¸€äº›å…¶ä»–çš„æ¸²æŸ“å†…å®¹ï¼›
2. å¯ä»¥å…±äº«çˆ¶ç±»æ–¹æ³•ï¼Œè¿˜å¯ä»¥æ·»åŠ é¢å¤–çš„æ–¹æ³•å’Œå±æ€§ã€‚

ä½†æ˜¯ä¹Ÿæœ‰å€¼å¾—æ³¨æ„çš„åœ°æ–¹ï¼Œå°±æ˜¯ state å’Œç”Ÿå‘½å‘¨æœŸä¼šè¢«ç»§æ‰¿åçš„ç»„ä»¶ä¿®æ”¹ã€‚åƒä¸Šè¿° demo ä¸­ï¼ŒPerson ç»„ä»¶ä¸­çš„ componentDidMount ç”Ÿå‘½å‘¨æœŸå°†ä¸ä¼šè¢«æ‰§è¡Œã€‚

**â‘¡å‡½æ•°ç»„ä»¶è‡ªå®šä¹‰ Hooks**

åœ¨è‡ªå®šä¹‰ hooks ç« èŠ‚ï¼Œä¼šè¯¦ç»†ä»‹ç»è‡ªå®šä¹‰ hooks çš„åŸç†å’Œç¼–å†™ã€‚

**â‘¢HOCé«˜é˜¶ç»„ä»¶**

åœ¨ HOC ç« èŠ‚ï¼Œä¼šè¯¦ç»†ä»‹ç»é«˜é˜¶ç»„ä»¶ HOC ã€‚

## State

> React æ˜¯æœ‰å¤šç§æ¨¡å¼çš„ï¼ŒåŸºæœ¬å¹³æ—¶ç”¨çš„éƒ½æ˜¯ legacy æ¨¡å¼ä¸‹çš„ Reactï¼Œé™¤äº†`legacy` æ¨¡å¼ï¼Œè¿˜æœ‰ `blocking` æ¨¡å¼å’Œ `concurrent` æ¨¡å¼ï¼Œ blocking å¯ä»¥è§†ä¸º concurrent çš„ä¼˜é›…é™çº§ç‰ˆæœ¬å’Œè¿‡æ¸¡ç‰ˆæœ¬ï¼ŒReact æœ€ç»ˆç›®çš„ï¼Œä¸ä¹…çš„æœªæ¥å°†ä»¥ concurrent æ¨¡å¼ä½œä¸ºé»˜è®¤ç‰ˆæœ¬ï¼Œè¿™ä¸ªæ¨¡å¼ä¸‹ä¼šå¼€å¯ä¸€äº›æ–°åŠŸèƒ½ã€‚
>
> å¯¹äº concurrent æ¨¡å¼ä¸‹ï¼Œä¼šé‡‡ç”¨ä¸åŒ State æ›´æ–°é€»è¾‘ã€‚å‰ä¸ä¹…é€éœ²å‡ºæœªæ¥çš„Reactv18 ç‰ˆæœ¬ï¼Œconcurrent å°†ä½œä¸ºä¸€ä¸ªç¨³å®šçš„åŠŸèƒ½å‡ºç°ã€‚

### ç±»ç»„ä»¶ä¸­çš„state

#### setStateç”¨æ³•

React é¡¹ç›®ä¸­ UI çš„æ”¹å˜æ¥æºäº state æ”¹å˜ï¼Œç±»ç»„ä»¶ä¸­ `setState` æ˜¯æ›´æ–°ç»„ä»¶ï¼Œæ¸²æŸ“è§†å›¾çš„ä¸»è¦æ–¹å¼ã€‚

å…¶åŸºæœ¬ç”¨æ³•å¦‚ä¸‹:

```js
setState(obj, callback)
```

- ç¬¬ä¸€ä¸ªå‚æ•°ï¼šå½“ obj ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™ä¸ºå³å°†åˆå¹¶çš„ state ï¼›å¦‚æœ obj æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆå½“å‰ç»„ä»¶çš„ state å’Œ props å°†ä½œä¸ºå‚æ•°ï¼Œè¿”å›å€¼ç”¨äºåˆå¹¶æ–°çš„ stateã€‚
- ç¬¬äºŒä¸ªå‚æ•° callback ï¼šcallback ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­å¯ä»¥è·å–å½“å‰ setState æ›´æ–°åçš„æœ€æ–° state çš„å€¼ï¼Œå¯ä»¥ä½œä¸ºä¾èµ– state å˜åŒ–çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥åšä¸€äº›åŸºäº DOM çš„æ“ä½œã€‚

```js
/* ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºfunctionç±»å‹ */
this.setState((state,props)=>{
    return { number:1 } 
})
/* ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºobjectç±»å‹ */
this.setState({ number:1 },()=>{
    console.log(this.state.number) //è·å–æœ€æ–°çš„number
})
```

å‡å¦‚ä¸€æ¬¡äº‹ä»¶ä¸­è§¦å‘ä¸€æ¬¡å¦‚ä¸Š setState ï¼Œåœ¨ React åº•å±‚ä¸»è¦åšäº†é‚£äº›äº‹å‘¢ï¼Ÿ

- é¦–å…ˆï¼ŒsetState ä¼šäº§ç”Ÿå½“å‰æ›´æ–°çš„ä¼˜å…ˆçº§ï¼ˆè€ç‰ˆæœ¬ç”¨ expirationTime ï¼Œæ–°ç‰ˆæœ¬ç”¨ lane ï¼‰ã€‚
- æ¥ä¸‹æ¥ React ä¼šä» fiber Root æ ¹éƒ¨ fiber å‘ä¸‹è°ƒå’Œå­èŠ‚ç‚¹ï¼Œè°ƒå’Œé˜¶æ®µå°†å¯¹æ¯”å‘ç”Ÿæ›´æ–°çš„åœ°æ–¹ï¼Œæ›´æ–°å¯¹æ¯” expirationTime ï¼Œæ‰¾åˆ°å‘ç”Ÿæ›´æ–°çš„ç»„ä»¶ï¼Œåˆå¹¶ stateï¼Œç„¶åè§¦å‘ render å‡½æ•°ï¼Œå¾—åˆ°æ–°çš„ UI è§†å›¾å±‚ï¼Œå®Œæˆ render é˜¶æ®µã€‚
- æ¥ä¸‹æ¥åˆ° commit é˜¶æ®µï¼Œcommit é˜¶æ®µï¼Œæ›¿æ¢çœŸå® DOM ï¼Œå®Œæˆæ­¤æ¬¡æ›´æ–°æµç¨‹ã€‚
- æ­¤æ—¶ä»ç„¶åœ¨ commit é˜¶æ®µï¼Œä¼šæ‰§è¡Œ setState ä¸­ callback å‡½æ•°,å¦‚ä¸Šçš„`()=>{ console.log(this.state.number) }`ï¼Œåˆ°æ­¤ä¸ºæ­¢å®Œæˆäº†ä¸€æ¬¡ setState å…¨è¿‡ç¨‹ã€‚

**æ›´æ–°çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š**

<img src="../../image/react/learning/01/setState_working.png" alt="setState_working.jpg" style="zoom: 50%;" />

è¯·è®°ä½ä¸€ä¸ªä¸»è¦ä»»åŠ¡çš„å…ˆåé¡ºåºï¼Œè¿™å¯¹äºå¼„æ¸…æ¸²æŸ“è¿‡ç¨‹å¯èƒ½ä¼šæœ‰å¸®åŠ©ï¼š
render é˜¶æ®µ render å‡½æ•°æ‰§è¡Œ -> commit é˜¶æ®µçœŸå® DOM æ›¿æ¢ -> setState å›è°ƒå‡½æ•°æ‰§è¡Œ callback ã€‚

**ç±»ç»„ä»¶å¦‚ä½•é™åˆ¶ state æ›´æ–°è§†å›¾**

å¯¹äºç±»ç»„ä»¶å¦‚ä½•é™åˆ¶ state å¸¦æ¥çš„æ›´æ–°ä½œç”¨çš„å‘¢ï¼Ÿ

- â‘  **pureComponent** å¯ä»¥å¯¹ state å’Œ props è¿›è¡Œæµ…æ¯”è¾ƒï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆç»„ä»¶ä¸æ›´æ–°ã€‚
- â‘¡ **shouldComponentUpdate** ç”Ÿå‘½å‘¨æœŸå¯ä»¥é€šè¿‡åˆ¤æ–­å‰å state å˜åŒ–æ¥å†³å®šç»„ä»¶éœ€ä¸éœ€è¦æ›´æ–°ï¼Œéœ€è¦æ›´æ–°è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚

#### setStateåŸç†

å¯¹äºç±»ç»„ä»¶ï¼Œç±»ç»„ä»¶åˆå§‹åŒ–è¿‡ç¨‹ä¸­ç»‘å®šäº†è´Ÿè´£æ›´æ–°çš„`Updater`å¯¹è±¡ï¼Œå¯¹äºå¦‚æœè°ƒç”¨ setState æ–¹æ³•ï¼Œå®é™…ä¸Šæ˜¯ React åº•å±‚è°ƒç”¨ Updater å¯¹è±¡ä¸Šçš„ **enqueueSetState** æ–¹æ³•ã€‚

å› ä¸ºè¦å¼„æ˜ç™½ state æ›´æ–°æœºåˆ¶ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥è¦ä»ä¸¤ä¸ªæ–¹å‘åˆ†æã€‚

- ä¸€æ˜¯æ­ç§˜ enqueueSetState åˆ°åº•åšäº†äº›ä»€ä¹ˆï¼Ÿ
- äºŒæ˜¯ React åº•å±‚æ˜¯å¦‚ä½•è¿›è¡Œæ‰¹é‡æ›´æ–°çš„ï¼Ÿ

é¦–å…ˆï¼Œè¿™é‡Œæè‡´ç²¾ç®€äº†ä¸€æ³¢ enqueueSetState ä»£ç ã€‚å¦‚ä¸‹

> react-reconciler/src/ReactFiberClassComponent.js

```js
enqueueSetState(){
     /* æ¯ä¸€æ¬¡è°ƒç”¨`setState`ï¼Œreact éƒ½ä¼šåˆ›å»ºä¸€ä¸ª update é‡Œé¢ä¿å­˜äº† */
     const update = createUpdate(expirationTime, suspenseConfig);
     /* callback å¯ä»¥ç†è§£ä¸º setState å›è°ƒå‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•° */
     callback && (update.callback = callback) 
     /* enqueueUpdate æŠŠå½“å‰çš„update ä¼ å…¥å½“å‰fiberï¼Œå¾…æ›´æ–°é˜Ÿåˆ—ä¸­ */
     enqueueUpdate(fiber, update); 
     /* å¼€å§‹è°ƒåº¦æ›´æ–° */
     scheduleUpdateOnFiber(fiber, expirationTime);
}
```

**enqueueSetState** ä½œç”¨å®é™…å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ª update ï¼Œç„¶å**æ”¾å…¥å½“å‰ fiber å¯¹è±¡çš„å¾…æ›´æ–°é˜Ÿåˆ—ä¸­ï¼Œæœ€åå¼€å¯è°ƒåº¦æ›´æ–°**ï¼Œè¿›å…¥ä¸Šè¿°è®²åˆ°çš„æ›´æ–°æµç¨‹ã€‚

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒReact çš„ batchUpdate æ‰¹é‡æ›´æ–°æ˜¯ä»€ä¹ˆæ—¶å€™åŠ ä¸Šå»çš„å‘¢ï¼Ÿ

è¿™å°±è¦æå‰èŠä¸€ä¸‹äº‹ä»¶ç³»ç»Ÿäº†ã€‚æ­£å¸¸ **state æ›´æ–°**ã€**UI äº¤äº’**ï¼Œéƒ½ç¦»ä¸å¼€ç”¨æˆ·çš„äº‹ä»¶ï¼Œæ¯”å¦‚ç‚¹å‡»äº‹ä»¶ï¼Œè¡¨å•è¾“å…¥ç­‰ï¼ŒReact æ˜¯é‡‡ç”¨äº‹ä»¶åˆæˆçš„å½¢å¼ï¼Œæ¯ä¸€ä¸ªäº‹ä»¶éƒ½æ˜¯ç”± React äº‹ä»¶ç³»ç»Ÿç»Ÿä¸€è°ƒåº¦çš„ï¼Œé‚£ä¹ˆ **State æ‰¹é‡æ›´æ–°æ­£æ˜¯å’Œäº‹ä»¶ç³»ç»Ÿæ¯æ¯ç›¸å…³çš„**ã€‚

> react-dom/src/events/DOMLegacyEventPluginSystem.js

```js
/* åœ¨`legacy`æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰çš„äº‹ä»¶éƒ½å°†ç»è¿‡æ­¤å‡½æ•°åŒä¸€å¤„ç† */
function dispatchEventForLegacyPluginEventSystem(){
    // handleTopLevel äº‹ä»¶å¤„ç†å‡½æ•°
    batchedEventUpdates(handleTopLevel, bookKeeping);
}
```

é‡ç‚¹æ¥äº†ï¼Œå°±æ˜¯ä¸‹é¢è¿™ä¸ª batchedEventUpdates æ–¹æ³•ã€‚

> react-dom/src/events/ReactDOMUpdateBatching.js

```js
function batchedEventUpdates(fn,a){
    /* å¼€å¯æ‰¹é‡æ›´æ–°  */
   isBatchingEventUpdates = true;
  try {
    /* è¿™é‡Œæ‰§è¡Œäº†çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œ æ¯”å¦‚åœ¨ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶ä¸­è§¦å‘setState,é‚£ä¹ˆå®ƒå°†åœ¨è¿™ä¸ªå‡½æ•°å†…æ‰§è¡Œ */
    return batchedEventUpdatesImpl(fn, a, b);
  } finally {
    /* try é‡Œé¢ return ä¸ä¼šå½±å“ finally æ‰§è¡Œ  */
    /* å®Œæˆä¸€æ¬¡äº‹ä»¶ï¼Œæ‰¹é‡æ›´æ–°  */
    isBatchingEventUpdates = false;
  }
}
```

å¦‚ä¸Šå¯ä»¥åˆ†æå‡ºæµç¨‹ï¼Œåœ¨ React äº‹ä»¶æ‰§è¡Œä¹‹å‰é€šè¿‡ `isBatchingEventUpdates=true` æ‰“å¼€å¼€å…³ï¼Œå¼€å¯äº‹ä»¶æ‰¹é‡æ›´æ–°ï¼Œå½“è¯¥äº‹ä»¶ç»“æŸï¼Œå†é€šè¿‡ `isBatchingEventUpdates = false;` å…³é—­å¼€å…³ï¼Œç„¶ååœ¨ scheduleUpdateOnFiber ä¸­æ ¹æ®è¿™ä¸ªå¼€å…³æ¥ç¡®å®šæ˜¯å¦è¿›è¡Œæ‰¹é‡æ›´æ–°ã€‚

> ä¹Ÿå°±æ˜¯è¯´æ‰¹é‡æ›´æ–°ä¸»è¦å–å†³äº`isBatchingEventUpdates`æ˜¯å¦å¼€å¯ï¼Œå¦‚æœå¼€å¯äº†å°±å¯ä»¥æ‰¹é‡æ›´æ–°ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯å°±ä¸è¿›è¡Œæ‰¹é‡æ›´æ–°

ä¸‹é¢æ˜¯ä¸€ä¸ªå®ä¾‹

```js
export default class index extends React.Component{
    state = { number:0 }
    handleClick= () => {
          this.setState({ number:this.state.number + 1 },()=>{   console.log( 'callback1', this.state.number)  })
          console.log(this.state.number)
          this.setState({ number:this.state.number + 1 },()=>{   console.log( 'callback2', this.state.number)  })
          console.log(this.state.number)
          this.setState({ number:this.state.number + 1 },()=>{   console.log( 'callback3', this.state.number)  })
          console.log(this.state.number)
    }
    render(){
        return <div>
            { this.state.number }
            <button onClick={ this.handleClick }  >number++</button>
        </div>
    }
} 
```

ç‚¹å‡»æ‰“å°ï¼š**0, 0, 0, callback1 1 ,callback2 1 ,callback3 1**

å¦‚ä¸Šä»£ç ï¼Œåœ¨æ•´ä¸ª React ä¸Šä¸‹æ–‡æ‰§è¡Œæ ˆä¸­ä¼šå˜æˆè¿™æ ·ï¼š

<img src="../../image/react/learning/01/setState_step.png" alt="setState_step" style="zoom:50%;" />

> ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥å‘ç°setStateçš„è¿‡ç¨‹ç›¸å½“äºæ”¶é›†ä¸€ä¸ªå‰¯ä½œç”¨çš„è¿‡ç¨‹ï¼Œä»–ä¼šåœ¨renderå‰æ‰ä¼šæ‰§è¡Œï¼Œä¸”æ˜¯æŒ‰ç…§æ”¶é›†çš„é¡ºåºè¿›è¡Œè§¦å‘çš„ã€‚
>
> è¿˜è¦æ³¨æ„ï¼Œè¿™é‡Œæ˜¯é¡ºåºæ‰§è¡Œï¼Œä¸å­˜åœ¨å¼‚æ­¥æ‰§è¡Œæƒ…å†µ

å¼‚æ­¥æ“ä½œé‡Œé¢çš„æ‰¹é‡æ›´æ–°è§„åˆ™ä¼šè¢«æ‰“ç ´ï¼Œæ¯”å¦‚ç”¨ promise æˆ–è€… setTimeout åœ¨ handleClick ä¸­è¿™ä¹ˆå†™ï¼š

```js
setTimeout(()=>{
    this.setState({ number:this.state.number + 1 },()=>{   console.log( 'callback1', this.state.number)  })
    console.log(this.state.number)
    this.setState({ number:this.state.number + 1 },()=>{    console.log( 'callback2', this.state.number)  })
    console.log(this.state.number)
    this.setState({ number:this.state.number + 1 },()=>{   console.log( 'callback3', this.state.number)  })
    console.log(this.state.number)
})
```

æ‰“å° ï¼š **callback1 1 , 1, callback2 2 , 2,callback3 3 , 3**

é‚£ä¹ˆåœ¨æ•´ä¸ª React ä¸Šä¸‹æ–‡æ‰§è¡Œæ ˆä¸­å°±ä¼šå˜æˆå¦‚ä¸‹å›¾è¿™æ ·:

<img src="../../image/react/learning/01/setState_sync.png" alt="setState_sync" style="zoom:50%;" />

**æ‰€ä»¥æ‰¹é‡æ›´æ–°è§„åˆ™è¢«æ‰“ç ´**ã€‚

**é‚£ä¹ˆï¼Œå¦‚ä½•åœ¨å¦‚ä¸Šå¼‚æ­¥ç¯å¢ƒä¸‹ï¼Œç»§ç»­å¼€å¯æ‰¹é‡æ›´æ–°æ¨¡å¼å‘¢ï¼Ÿ**

React-Dom ä¸­æä¾›äº†æ‰¹é‡æ›´æ–°æ–¹æ³• `unstable_batchedUpdates`ï¼Œå¯ä»¥å»**æ‰‹åŠ¨æ‰¹é‡æ›´æ–°**ï¼Œå¯ä»¥å°†ä¸Šè¿° setTimeout é‡Œé¢çš„å†…å®¹åšå¦‚ä¸‹ä¿®æ”¹:

```js
import ReactDOM from 'react-dom'
const { unstable_batchedUpdates } = ReactDOM
setTimeout(()=>{
    unstable_batchedUpdates(()=>{
        this.setState({ number:this.state.number + 1 },()=>{   console.log( 'callback1', this.state.number)  })
        console.log(this.state.number)
        this.setState({ number:this.state.number + 1 },()=>{    console.log( 'callback2', this.state.number)  })
        console.log(this.state.number)
        this.setState({ number:this.state.number + 1 },()=>{   console.log( 'callback3', this.state.number)  })
        console.log(this.state.number) 
    })
})
```

> å…¶å®è¿™é‡Œä¸»è¦çš„å°±æ˜¯æ‰¹é‡æ›´æ–°çš„æ¦‚å¿µï¼Œå°±æ˜¯è·å–æ”¹å˜ä¸€æ¬¡çš„æ›´æ–°ï¼Œä½œç”¨åœ¨å…¨éƒ¨çš„ä½œç”¨å‡½æ•°ä¸­ï¼Œä¸”æ•°æ®ä¸å‘ç”Ÿæ”¹å˜ï¼Œä¸”æ˜¯æŒ‰ç…§é¡ºåºæ‰§è¡Œçš„æµç¨‹è¿›è¡Œæ‰§è¡Œã€‚

æ‰“å°ï¼š **0 , 0 , 0 , callback1 1 , callback2 1 ,callback3 1**

åœ¨å®é™…å·¥ä½œä¸­ï¼Œunstable_batchedUpdates å¯ä»¥ç”¨äº Ajax æ•°æ®äº¤äº’ä¹‹åï¼Œåˆå¹¶å¤šæ¬¡ setStateï¼Œæˆ–è€…æ˜¯å¤šæ¬¡ useState ã€‚åŸå› å¾ˆç®€å•ï¼Œæ‰€æœ‰çš„æ•°æ®äº¤äº’éƒ½æ˜¯åœ¨å¼‚æ­¥ç¯å¢ƒä¸‹ï¼Œå¦‚æœæ²¡æœ‰æ‰¹é‡æ›´æ–°å¤„ç†ï¼Œä¸€æ¬¡æ•°æ®äº¤äº’å¤šæ¬¡æ”¹å˜ state ä¼šä¿ƒä½¿è§†å›¾å¤šæ¬¡æ¸²æŸ“ã€‚

**é‚£ä¹ˆå¦‚ä½•æå‡æ›´æ–°ä¼˜å…ˆçº§å‘¢ï¼Ÿ**

**React-dom æä¾›äº† flushSync ï¼ŒflushSync å¯ä»¥å°†å›è°ƒå‡½æ•°ä¸­çš„æ›´æ–°ä»»åŠ¡ï¼Œæ”¾åœ¨ä¸€ä¸ªè¾ƒé«˜çš„ä¼˜å…ˆçº§ä¸­**ã€‚React è®¾å®šäº†å¾ˆå¤šä¸åŒä¼˜å…ˆçº§çš„æ›´æ–°ä»»åŠ¡ã€‚å¦‚æœä¸€æ¬¡æ›´æ–°ä»»åŠ¡åœ¨ flushSync å›è°ƒå‡½æ•°å†…éƒ¨ï¼Œé‚£ä¹ˆå°†è·å¾—ä¸€ä¸ªè¾ƒé«˜ä¼˜å…ˆçº§çš„æ›´æ–°ã€‚

æ¥ä¸‹æ¥ï¼Œå°†ä¸Šè¿° `handleClick` æ”¹ç‰ˆå¦‚ä¸‹æ ·å­ï¼š

```js
handerClick=()=>{
    setTimeout(()=>{
        this.setState({ number: 1  })
    })
    this.setState({ number: 2  })
    ReactDOM.flushSync(()=>{
        this.setState({ number: 3  })
    })
    this.setState({ number: 4  })
}
render(){
   console.log(this.state.number)
   return ...
}
```

æ‰“å° **3 4 1** ï¼Œç›¸ä¿¡ä¸éš¾ç†è§£ä¸ºä»€ä¹ˆè¿™ä¹ˆæ‰“å°äº†ã€‚

- é¦–å…ˆ `flushSync` `this.setState({ number: 3 })`è®¾å®šäº†ä¸€ä¸ªé«˜ä¼˜å…ˆçº§çš„æ›´æ–°ï¼Œæ‰€ä»¥ 2 å’Œ 3 è¢«æ‰¹é‡æ›´æ–°åˆ° 3 ï¼Œæ‰€ä»¥ 3 å…ˆè¢«æ‰“å°ã€‚
- æ›´æ–°ä¸º 4ã€‚
- æœ€åæ›´æ–° setTimeout ä¸­çš„ number = 1ã€‚

**flushSyncè¡¥å……è¯´æ˜**ï¼šflushSync åœ¨åŒæ­¥æ¡ä»¶ä¸‹ï¼Œä¼šåˆå¹¶ä¹‹å‰çš„ setState | useStateï¼Œå¯ä»¥ç†è§£æˆï¼Œå¦‚æœå‘ç°äº† flushSync ï¼Œå°±ä¼šå…ˆæ‰§è¡Œæ›´æ–°ï¼Œå¦‚æœä¹‹å‰æœ‰æœªæ›´æ–°çš„ setState ï½œ useState ï¼Œå°±ä¼šä¸€èµ·åˆå¹¶äº†ï¼Œæ‰€ä»¥å°±è§£é‡Šäº†å¦‚ä¸Šï¼Œ2 å’Œ 3 è¢«æ‰¹é‡æ›´æ–°åˆ° 3 ï¼Œæ‰€ä»¥ 3 å…ˆè¢«æ‰“å°ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œ React åŒä¸€çº§åˆ«**æ›´æ–°ä¼˜å…ˆçº§**å…³ç³»æ˜¯:

flushSync ä¸­çš„ setState **>** æ­£å¸¸æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­ setState **>** setTimeout ï¼ŒPromise ä¸­çš„ setStateã€‚

### å‡½æ•°ç»„ä»¶ä¸­çš„state

React-hooks æ­£å¼å‘å¸ƒä»¥åï¼Œ useState å¯ä»¥ä½¿å‡½æ•°ç»„ä»¶åƒç±»ç»„ä»¶ä¸€æ ·æ‹¥æœ‰ stateï¼Œä¹Ÿå°±è¯´æ˜å‡½æ•°ç»„ä»¶å¯ä»¥é€šè¿‡ useState æ”¹å˜ UI è§†å›¾ã€‚é‚£ä¹ˆ useState åˆ°åº•åº”è¯¥å¦‚ä½•ä½¿ç”¨ï¼Œåº•å±‚åˆæ˜¯æ€ä¹ˆè¿ä½œçš„å‘¢ï¼Œé¦–å…ˆä¸€èµ·çœ‹ä¸€ä¸‹ useState ã€‚

#### useState

**åŸºæœ¬ç”¨æ³•**

```js
 [ â‘ state , â‘¡dispatch ] = useState(â‘¢initData)
```

- â‘  stateï¼Œç›®çš„æä¾›ç»™ UI ï¼Œä½œä¸ºæ¸²æŸ“è§†å›¾çš„æ•°æ®æºã€‚
- â‘¡ dispatch æ”¹å˜ state çš„å‡½æ•°ï¼Œå¯ä»¥ç†è§£ä¸ºæ¨åŠ¨å‡½æ•°ç»„ä»¶æ¸²æŸ“çš„æ¸²æŸ“å‡½æ•°ã€‚
- â‘¢ initData æœ‰ä¸¤ç§æƒ…å†µï¼Œç¬¬ä¸€ç§æƒ…å†µæ˜¯éå‡½æ•°ï¼Œå°†ä½œä¸º state åˆå§‹åŒ–çš„å€¼ã€‚ ç¬¬äºŒç§æƒ…å†µæ˜¯å‡½æ•°ï¼Œå‡½æ•°çš„è¿”å›å€¼ä½œä¸º useState åˆå§‹åŒ–çš„å€¼ã€‚

initData ä¸ºéå‡½æ•°çš„æƒ…å†µ:

```js
/* æ­¤æ—¶å°†æŠŠ 0 ä½œä¸ºåˆä½¿å€¼ */
const [ number , setNumber ] = React.useState(0)
```

initData ä¸ºå‡½æ•°çš„æƒ…å†µ:

```js
const [ number , setNumber ] = React.useState(()=>{
    /*  props ä¸­ a = 1 state ä¸º 0-1 éšæœºæ•° ï¼Œ a = 2 state ä¸º 1 -10éšæœºæ•° ï¼Œ å¦åˆ™ï¼Œstate ä¸º 1 - 100 éšæœºæ•°   */
    if(props.a === 1) return Math.random() 
    if(props.a === 2) return Math.ceil(Math.random() * 10 )
    return Math.ceil(Math.random() * 100 ) 
})
```

å¯¹äº dispatchçš„å‚æ•°,ä¹Ÿæœ‰ä¸¤ç§æƒ…å†µï¼š

- ç¬¬ä¸€ç§éå‡½æ•°æƒ…å†µï¼Œæ­¤æ—¶å°†ä½œä¸ºæ–°çš„å€¼ï¼Œèµ‹äºˆç»™ stateï¼Œä½œä¸ºä¸‹ä¸€æ¬¡æ¸²æŸ“ä½¿ç”¨;
- ç¬¬äºŒç§æ˜¯å‡½æ•°çš„æƒ…å†µï¼Œå¦‚æœ dispatch çš„å‚æ•°ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œè¿™é‡Œå¯ä»¥ç§°å®ƒä¸ºreducerï¼Œreducer å‚æ•°ï¼Œæ˜¯ä¸Šä¸€æ¬¡è¿”å›æœ€æ–°çš„ stateï¼Œè¿”å›å€¼ä½œä¸ºæ–°çš„ stateã€‚

**dispatch å‚æ•°æ˜¯ä¸€ä¸ªéå‡½æ•°å€¼**

```js
const [ number , setNumber ] = React.useState(0)
/* ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ */
const handleClick=()=>{
   setNumber(1)
   setNumber(2)
   setNumber(3)
}
```

**dispatch å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°**

```js
const [ number , setNumber ] = React.useState(0)
const handleClick=()=>{
   setNumber((state)=> state + 1)  // state - > 0 + 1 = 1
   setNumber(8)  // state - > 8
   setNumber((state)=> state + 1)  // state - > 8 + 1 = 9
}
```

> useStateçš„å£°æ˜åï¼Œè¿”å›çš„ç¬¬äºŒä¸ªå†…å®¹ï¼Œå¯ä»¥ç”¨æ¥ä¿®æ”¹å‚æ•°å€¼ï¼Œé‡Œé¢å¯ä»¥æ¥æ”¶å‡½æ•°ã€éå‡½æ•°å†…å®¹

#### ç›‘å¬Stateå˜åŒ–

ç±»ç»„ä»¶ setState ä¸­ï¼Œ**æœ‰ç¬¬äºŒä¸ªå‚æ•° callback æˆ–è€…æ˜¯ç”Ÿå‘½å‘¨æœŸcomponentDidUpdate å¯ä»¥æ£€æµ‹ç›‘å¬åˆ° state æ”¹å˜æˆ–æ˜¯ç»„ä»¶æ›´æ–°**ã€‚

é‚£ä¹ˆåœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œå¦‚ä½•æ€ä¹ˆç›‘å¬ state å˜åŒ–å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™å°±éœ€è¦ **useEffect** å‡ºåœºäº†ï¼Œé€šå¸¸å¯ä»¥æŠŠ state ä½œä¸ºä¾èµ–é¡¹ä¼ å…¥ useEffect ç¬¬äºŒä¸ªå‚æ•° deps ï¼Œä½†æ˜¯æ³¨æ„ useEffect åˆå§‹åŒ–ä¼šé»˜è®¤æ‰§è¡Œä¸€æ¬¡ã€‚

å…·ä½“å¯ä»¥å‚è€ƒå¦‚ä¸‹ Demo :

```js
export default function Index(props){
    const [ number , setNumber ] = React.useState(0)
    /* ç›‘å¬ number å˜åŒ– */
    React.useEffect(()=>{
        console.log('ç›‘å¬numberå˜åŒ–ï¼Œæ­¤æ—¶çš„numberæ˜¯:  ' + number )
    },[ number ])
    const handerClick = ()=>{
        /** é«˜ä¼˜å…ˆçº§æ›´æ–° **/
        ReactDOM.flushSync(()=>{
            setNumber(2) 
        })
        /* æ‰¹é‡æ›´æ–° */
        setNumber(1) 
        /* æ»åæ›´æ–° ï¼Œæ‰¹é‡æ›´æ–°è§„åˆ™è¢«æ‰“ç ´ */
        setTimeout(()=>{
            setNumber(3) 
        })
       
    }
    console.log(number)
    return <div>
        <span> { number }</span>
        <button onClick={ handerClick }  >number++</button>
    </div>
}
```

æ•ˆæœ:

<img src="../../image/react/learning/01/watch_state_change.png" alt="watch_state_change" style="zoom:50%;" />

> å‡½æ•°ç»„ä»¶ï¼šuseEffectè¿›è¡Œç›‘å¬
>
> å¯¹è±¡ç»„ä»¶ï¼šç¬¬äºŒä¸ªå‚æ•° callback æˆ–è€…æ˜¯ç”Ÿå‘½å‘¨æœŸcomponentDidUpdate

#### dispatchæ›´æ–°ç‰¹ç‚¹

ä¸Šè¿°è®²çš„æ‰¹é‡æ›´æ–°å’Œ flushSync ï¼Œåœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œdispatch æ›´æ–°æ•ˆæœå’Œç±»ç»„ä»¶æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ useState æœ‰ä¸€ç‚¹å€¼å¾—æ³¨æ„ï¼Œå°±æ˜¯å½“è°ƒç”¨æ”¹å˜ state çš„å‡½æ•°dispatchï¼Œåœ¨æœ¬æ¬¡å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­ï¼Œæ˜¯è·å–ä¸åˆ°æœ€æ–°çš„ state å€¼çš„ï¼ŒæŠŠä¸Šè¿°demo å¦‚ä¸‹è¿™ä¹ˆæ”¹ï¼š

```js
const [ number , setNumber ] = React.useState(0)
const handleClick = ()=>{
    ReactDOM.flushSync(()=>{
        setNumber(2) 
        console.log(number) 
    })
    setNumber(1) 
    console.log(number)
    setTimeout(()=>{
        setNumber(3) 
        console.log(number)
    })   
}
```

**ç»“æœï¼š 0 0 0**

åŸå› å¾ˆç®€å•ï¼Œ**å‡½æ•°ç»„ä»¶æ›´æ–°å°±æ˜¯å‡½æ•°çš„æ‰§è¡Œï¼Œåœ¨å‡½æ•°ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå‡½æ•°å†…éƒ¨æ‰€æœ‰å˜é‡é‡æ–°å£°æ˜ï¼Œæ‰€ä»¥æ”¹å˜çš„ state** ï¼Œåªæœ‰åœ¨ä¸‹ä¸€æ¬¡å‡½æ•°ç»„ä»¶æ‰§è¡Œæ—¶æ‰ä¼šè¢«æ›´æ–°ã€‚æ‰€ä»¥åœ¨å¦‚ä¸ŠåŒä¸€ä¸ªå‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­ï¼Œnumber ä¸€ç›´ä¸º0ï¼Œæ— è®ºæ€ä¹ˆæ‰“å°ï¼Œéƒ½æ‹¿ä¸åˆ°æœ€æ–°çš„ state ã€‚

**useStateæ³¨æ„äº‹é¡¹**

åœ¨ä½¿ç”¨ useState çš„ dispatchAction æ›´æ–° state çš„æ—¶å€™ï¼Œè®°å¾—ä¸è¦ä¼ å…¥ç›¸åŒçš„ stateï¼Œè¿™æ ·ä¼šä½¿è§†å›¾ä¸æ›´æ–°ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¹ˆå†™ï¼š

```js
export default function Index(){
    const [ state  , dispatchState ] = useState({ name:'alien' })
    const  handleClick = ()=>{ // ç‚¹å‡»æŒ‰é’®ï¼Œè§†å›¾æ²¡æœ‰æ›´æ–°ã€‚
        state.name = 'Alien'
        dispatchState(state) // ç›´æ¥æ”¹å˜ `state`ï¼Œåœ¨å†…å­˜ä¸­æŒ‡å‘çš„åœ°å€ç›¸åŒã€‚
    }
    return <div>
         <span> { state.name }</span>
        <button onClick={ handleClick }  >changeName++</button>
    </div>
}
```

å¦‚ä¸Šä¾‹å­ğŸŒ°ä¸­ï¼Œå½“ç‚¹å‡»æŒ‰é’®åï¼Œå‘ç°è§†å›¾æ²¡æœ‰æ”¹å˜ï¼Œä¸ºä»€ä¹ˆä¼šé€ æˆè¿™ä¸ªåŸå› å‘¢ï¼Ÿ

åœ¨ useState çš„ dispatchAction å¤„ç†é€»è¾‘ä¸­ï¼Œä¼šæµ…æ¯”è¾ƒä¸¤æ¬¡ state ï¼Œå‘ç° state ç›¸åŒï¼Œä¸ä¼šå¼€å¯æ›´æ–°è°ƒåº¦ä»»åŠ¡ï¼› demo ä¸­ä¸¤æ¬¡ state æŒ‡å‘äº†ç›¸åŒçš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥é»˜è®¤ä¸º state ç›¸ç­‰ï¼Œå°±ä¸ä¼šå‘ç”Ÿè§†å›¾æ›´æ–°äº†ã€‚

è§£å†³é—®é¢˜ï¼š **æŠŠä¸Šè¿°çš„ dispatchState æ”¹æˆ dispatchState({...state}) æ ¹æœ¬è§£å†³äº†é—®é¢˜ï¼Œæµ…æ‹·è´äº†å¯¹è±¡ï¼Œé‡æ–°ç”³è¯·äº†ä¸€ä¸ªå†…å­˜ç©ºé—´**ã€‚

> å¯¹äºå‡½æ•°å£°æ˜çš„state,è°ƒç”¨dispatchæ—¶ï¼Œéœ€è¦æ³¨æ„ä¸èƒ½ä¼ å…¥åŸstateå¯¹è±¡ï¼Œè¿™æ ·ä¼šè®¤ä¸ºæ²¡æœ‰å‘ç”Ÿä¿®æ”¹ï¼Œéœ€è¦ç»“æ„ç”³è¯·æ–°çš„å†…å­˜ç©ºé—´æ‰å¯ä»¥ã€‚

### useStateåŸç†æ­ç§˜

å¯¹äº useState åŸç†ï¼Œåé¢ä¼šæœ‰ç‹¬ç«‹çš„ç¯‡ç« ä»‹ç»ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚

**ï½œ--------é—®ä¸ç­”---------ï½œ**

ç±»ç»„ä»¶ä¸­çš„ `setState` å’Œå‡½æ•°ç»„ä»¶ä¸­çš„ `useState` æœ‰ä»€ä¹ˆå¼‚åŒï¼Ÿ **ç›¸åŒç‚¹ï¼š**

- é¦–å…ˆä»åŸç†è§’åº¦å‡ºå‘ï¼ŒsetStateå’Œ useState æ›´æ–°è§†å›¾ï¼Œåº•å±‚éƒ½è°ƒç”¨äº† scheduleUpdateOnFiber æ–¹æ³•ï¼Œè€Œä¸”äº‹ä»¶é©±åŠ¨æƒ…å†µä¸‹éƒ½æœ‰æ‰¹é‡æ›´æ–°è§„åˆ™ã€‚

**ä¸åŒç‚¹**

- åœ¨ä¸æ˜¯ pureComponent ç»„ä»¶æ¨¡å¼ä¸‹ï¼Œ setState ä¸ä¼šæµ…æ¯”è¾ƒä¸¤æ¬¡ state çš„å€¼ï¼Œåªè¦è°ƒç”¨ setStateï¼Œåœ¨æ²¡æœ‰å…¶ä»–ä¼˜åŒ–æ‰‹æ®µçš„å‰æä¸‹ï¼Œå°±ä¼šæ‰§è¡Œæ›´æ–°ã€‚ä½†æ˜¯ useState ä¸­çš„ dispatchAction ä¼šé»˜è®¤æ¯”è¾ƒä¸¤æ¬¡ state æ˜¯å¦ç›¸åŒï¼Œç„¶åå†³å®šæ˜¯å¦æ›´æ–°ç»„ä»¶ã€‚
- setState æœ‰ä¸“é—¨ç›‘å¬ state å˜åŒ–çš„å›è°ƒå‡½æ•° callbackï¼Œå¯ä»¥è·å–æœ€æ–°stateï¼›ä½†æ˜¯åœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œåªèƒ½é€šè¿‡ useEffect æ¥æ‰§è¡Œ state å˜åŒ–å¼•èµ·çš„å‰¯ä½œç”¨ã€‚
- setState åœ¨åº•å±‚å¤„ç†é€»è¾‘ä¸Šä¸»è¦æ˜¯å’Œè€ state è¿›è¡Œåˆå¹¶å¤„ç†ï¼Œè€Œ useState æ›´å€¾å‘äºé‡æ–°èµ‹å€¼ã€‚