# Vue3ä¹‹Diffç®—æ³•å­¦ä¹ 

| æ–‡æ¡£åˆ›å»ºäºº | åˆ›å»ºæ—¥æœŸ   | æ–‡æ¡£å†…å®¹          | æ›´æ–°æ—¶é—´   |
| ---------- | ---------- | ----------------- | ---------- |
| adsionli   | 2022-07-15 | Vue3 Diffç®—æ³•å­¦ä¹  | 2022-07-17 |

åœ¨ä¸Šä¸€ç¯‡ä¸­ï¼Œæ•´ç†ä¸€ä¸‹å…³äºç®€å•`Diff`å’ŒåŒç«¯`Diff`çš„å®ç°æ€è·¯ï¼Œåœ¨è¿™ä¸€ç« ä¸­ï¼Œå°±æ•´ç†ä¸€ä¸‹å…³äºå¿«é€Ÿ`Diff`çš„è®¾è®¡æ€è·¯ã€‚

å¿«é€Ÿ`Diff`æ˜¯åœ¨`vue3`ä¸­è¢«ç”¨äºæ›¿ä»£åŒç«¯`Diff`çš„ä¸€ç§æ–°çš„`Diff`ç®—æ³•ï¼Œä¹Ÿæ˜¯å‚è€ƒäº†å…¶ä»–ä¸¤ä¸ªè™šæ‹ŸèŠ‚ç‚¹åº“çš„å¿«é€ŸDiffçš„å®ç°(`ivi`ä¸`inferno `)ã€‚

å¿«é€Ÿ`Diff`ç›¸æ¯”äºåŒç«¯`Diff`æ¥è¯´ï¼Œå®ç°èµ·æ¥ä¼šæ›´åŠ å¤æ‚ä¸€äº›ï¼Œæ‰€ä»¥ä¼šæ¯”åŒç«¯ç¨å¾®éš¾ç†è§£ä¸€äº›ï¼Œå› ä¸ºæ­¥éª¤æœ‰ä¸€ç‚¹å¤šï¼Œè€Œä¸”å®ç°çš„ç®—æ³•ä¹Ÿè¦æ¯”åŒç«¯æ¥çš„å¤æ‚ï¼Œæ‰€ä»¥ä¸‹é¢æˆ‘ä»¬å°±æ¥ä¸€æ­¥ä¸€æ­¥å­¦ä¹ å¿«é€ŸDiffçš„å®ç°ï¼Œæˆ‘å°½é‡æŠŠæ¯ä¸€ä¸ªæ­¥éª¤éƒ½æ•´ç†ä¸æè¿°æ¸…æ™°ï¼Œæ–¹ä¾¿è‡ªå·±ç†è§£ä¹Ÿæ–¹ä¾¿å¤§å®¶ç†è§£ã€‚

## 1. æ­¥éª¤æ€»è§ˆ

ä¸ºäº†ä¹‹åå¥½ç†è§£ï¼Œå…ˆæŠŠå¿«é€ŸDiffçš„å®ç°æ­¥éª¤å…ˆæ•´ç†ä¸€ä¸‹

1. é¢„å¤„ç†æ–°èŠ‚ç‚¹ç»„ä¸æ—§èŠ‚ç‚¹ç»„ç›¸åŒçš„å‰ç½®èŠ‚ç‚¹ä¸åç½®èŠ‚ç‚¹ï¼ŒåŠ é€ŸèŠ‚ç‚¹å¤„ç†ã€‚

2. å°†é¢„å¤„ç†åçš„æ–°èŠ‚ç‚¹ç»„å’Œæ—§èŠ‚ç‚¹ç»„ä¸ç›¸åŒçš„æ•°æ®æå–å‡ºæ¥ï¼Œå¹¶ç»§ç»­åˆ¤æ–­æ˜¯å¦éœ€è¦ç§»åŠ¨èŠ‚ç‚¹ä½ç½®ã€‚

3. æ„å»ºæ–°èŠ‚ç‚¹ç»„å‰©ä½™å¾…å¤„ç†æ•°æ®çš„`key`ä¸`index`æ˜ å°„ï¼Œå¹¶æ„å»ºæ–°èŠ‚ç‚¹ç»„ç›¸å¯¹äºæ—§èŠ‚ç‚¹ç»„ä½ç½®è®°å½•çš„æ˜ å°„å…³ç³»æ•°ç»„

   > å°±æ˜¯å°†æ–°èŠ‚ç‚¹ç»„å±äºå¾…å¤„ç†æ•°æ®åœ¨æ—§èŠ‚ç‚¹ç»„ä¸­çš„`index`æ˜ å°„å…¥ä¸€ä¸ª`sourceMap`ä¸­è¿›è¡Œè®°å½•ã€‚
   >
   > è¿™é‡Œçš„æ˜ å°„å…³ç³»æ˜¯`newChildren.get(key).index` <=> `oldChildren.get(newChildren[i].key).index`
   >
   > å°±æ˜¯ä¸Šé¢çš„è¿™ç§å…³ç³»æ˜ å°„ã€‚

4. å¦‚æœèŠ‚ç‚¹éœ€è¦ç§»åŠ¨ï¼Œåœ¨è·å–`sourceMap`çš„æœ€é•¿é€’å¢å­åºåˆ—ï¼Œä»¥å¤‡ä¹‹åçš„æ¯”è¾ƒä½¿ç”¨

5. ä¸ºæœ€é•¿é€’å¢å­åºåˆ—ä¸`sourceMap`å»ºç«‹ç±»ä¼¼åŒç«¯`Diff`æ—¶çš„æŒ‡é’ˆå¯¹æ¯”ï¼Œä¸è¿‡åªéœ€è¦ä¸¤è€…çš„å°¾æŒ‡é’ˆå³å¯ï¼Œç„¶åé€ä¸€æ¯”è¾ƒï¼Œè·å–æ–°çš„é”šç‚¹ï¼Œè¿›è¡Œä½ç½®ç§»åŠ¨ã€‚

ä¸Šé¢å°±æ˜¯æˆ‘ä»¬éœ€è¦å®Œæˆçš„å†…å®¹ï¼Œç°åœ¨æ¥çœ‹è¿˜æ˜¯æ¯”è¾ƒæŠ½è±¡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†é…åˆç€å„è‡ªæµç¨‹çš„ç¤ºæ„å›¾

## 2. å…·ä½“å®ç°

æ¥ä¸‹æ¥æˆ‘å°†å¯¹ä¸Šé¢æ•´ç†çš„æ­¥éª¤è¿›è¡Œä¸€æ­¥ä¸€æ­¥çš„å®ç°ï¼Œé…åˆä»£ç ä¸ç¤ºæ„å›¾ï¼Œæ¢³ç†ç›¸å…³å†…å®¹ã€‚

### 2.1 é¢„å¤„ç†

å¿«é€ŸDiffä¸€ä¸ªåŠ é€Ÿçš„ç‚¹å°±åœ¨äºé¢„å¤„ç†äº†ç›¸åŒçš„å‰ç½®èŠ‚ç‚¹ä¸åç½®èŠ‚ç‚¹ï¼Œå› ä¸ºå¯¹äºç›¸åŒçš„å‰ç½®ä¸åç½®èŠ‚ç‚¹æ¥è¯´ï¼Œä»–ä»¬çš„ç›¸å¯¹ä½ç½®å®é™…æ˜¯æ²¡æœ‰è¿›è¡Œç§»åŠ¨çš„ï¼Œå¦‚æœåœ¨ç†æƒ³æƒ…å†µä¸‹ï¼ŒèŠ‚ç‚¹å‡æœªè¿›è¡Œç§»åŠ¨ï¼Œé‚£ä¹ˆå‰ç½®ä¸åç½®èŠ‚ç‚¹å…¨éƒ¨ç›¸åŒï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦å»ä¸€ä¸€å¯¹æ¯”èŠ‚ç‚¹ç§»åŠ¨é—®é¢˜ï¼Œç›´æ¥è¿›è¡Œ`patch`æ›´æ–°ã€‚ç”šè‡³åœ¨æ›´ç†æƒ³çš„æƒ…å†µä¸‹ï¼Œæ–°å¢æˆ–å¸è½½çš„èŠ‚ç‚¹éƒ½åœ¨ä¹‹å‰å·²å­˜åœ¨ç›¸åŒçš„åç½®ä¸å‰ç½®èŠ‚ç‚¹ä¹‹å‰ï¼Œé‚£ä¹ˆç›´æ¥è¿›è¡Œè£…è½½æˆ–å¸è½½å°±å®Œäº‹äº†ã€‚è¿™å‡ ç§ç‰¹æ®Šçš„ç†æƒ³æƒ…å†µçš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![precompute_node](../../image/vue/quickDiff/quickDiff_pre.jpg)

é‚£ä¹ˆé’ˆå¯¹å›¾ä¸­çš„ä¸‰ç§æƒ…å†µï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥å®ç°ä¸€ä¸‹æˆ‘ä»¬çš„ä»£ç ã€‚

```typescript
const quickDiff = function(newChildren: VNode[], oldChildren: VNode[], container: Node) {
    let start = 0;
    let newEnd = newChildren.length - 1;
    let oldEnd = oldChildren.length - 1;
    //README: ç›¸åŒçš„å‰ç½®èŠ‚ç‚¹è¿›è¡Œæ›´æ–°å³å¯ï¼Œå› ä¸ºå®ƒä»¬çš„çœŸå®Domä½ç½®æœªå‘ç”Ÿæ”¹å˜ï¼Œä¸éœ€è¦ç§»åŠ¨
    while(newChildren[start].key === oldChildren[start].key) {
        patch(oldChildren[start], newChildren[start], container);
        //NOTE: æ›´æ–°å¤´æŒ‡é’ˆçš„ä½ç½®ï¼Œè¿›è¡Œä¸‹ä¸€ä½çš„æ¯”è¾ƒ
        start++;
    }
    //README: ç›¸åŒçš„åç½®èŠ‚ç‚¹è¿›è¡Œæ›´æ–°å³å¯ï¼Œå› ä¸ºå®ƒä»¬çš„çœŸå®Domçš„ç›¸å¯¹ä½ç½®å…¶å®æœªå‘ç”Ÿæ”¹å˜ï¼Œä¹‹ååªè¦åœ¨å®ƒä»¬ä¹‹å‰è¿›è¡Œæ’å…¥å³å¯ï¼Œæ— éœ€ç§»åŠ¨
    while(newChildren[newEnd].key === oldChildren[oldEnd].key) {
        patch(oldChildren[oldEnd], newChildren[newEnd], container);
        //NOTE: æ›´æ–°å°¾éƒ¨æŒ‡é’ˆä½ç½®
        newEnd--;
        oldEnd--;
    }
    
    //README: åœ¨ä¸Šè¿°å‰ç½®ä¸åç½®èŠ‚ç‚¹å¤„ç†å¥½ä¹‹åï¼Œè¿›è¡Œä¸¤ç§ç†æƒ³æƒ…å†µçš„åˆ¤æ–­
    if(newEnd > start && oldEnd >= start) {
        //README: ç¬¬ä¸€ç§æƒ…å†µï¼Œæ–°èŠ‚ç‚¹ç»„å…¨éƒ¨å¤„ç†å®Œäº†ï¼Œä½†æ˜¯æ—§èŠ‚ç‚¹ç»„è¿˜å­˜åœ¨æœªé¢„è®¡ç®—æ•°æ®ï¼Œé‚£ä¹ˆè¯´æ˜è¿™äº›æ•°æ®éœ€è¦å…¨éƒ¨å¸è½½
        for(let i = start; i <= oldEnd; i++) {
            unmount(oldChildren[i]);
        }
    }else if(oldEnd > start && newEnd >= start) {
        //README: ç¬¬äºŒç§æƒ…å†µï¼Œæ—§èŠ‚ç‚¹ç»„å†…æ•°æ®å…¨éƒ¨è¢«é¢„è®¡ç®—å¤„ç†æ‰äº†ï¼Œä½†æ˜¯æ–°èŠ‚ç‚¹ç»„å†…è¿˜å­˜åœ¨æœªå¤„ç†æ•°æ®ï¼Œè¯´æ˜å…¨éƒ¨éƒ½æ˜¯æ–°å¢èŠ‚ç‚¹
        //NOTE: é€‰å–åˆé€‚çš„é”šç‚¹ï¼Œé”šç‚¹é€‰æ‹©çš„å°±æ˜¯å°¾æŒ‡é’ˆæŒ‡å‘çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ä½ç½®ï¼Œå› ä¸ºç”¨çš„æ’å…¥ä¸ºinsertBefore
        let anchorIndex = newEnd + 1;
        let anchor = anchorIndex > newChildren.length ? newChildren[anchorIndex].el : null;
        for(let i = start; i <= newEnd; i++) {
            patch(null, newChildren[i], container, anchor)
        }
    }
}
```

åœ¨ä¸Šæ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ç”³æ˜`start`å¤´æŒ‡é’ˆä¸`oldEnd`,`newEnd`ä¸¤ä¸ªå°¾æŒ‡é’ˆï¼Œæ¥æ§åˆ¶`newChildren`ä¸`oldChildren`çš„å¤´å°¾æ¯”è¾ƒã€‚

> ä¸åŒå°¾æŒ‡é’ˆæ˜¯å› ä¸º`newChildren`ä¸`oldChildren`é•¿åº¦ä¼šå­˜åœ¨ä¸åŒï¼Œä½†æ˜¯ç›¸åŒçš„`start`æ˜¯å› ä¸ºéƒ½ä»å¤´å¼€å§‹çš„ã€‚

ç„¶åæˆ‘ä»¬å†é€šè¿‡ä¸¤æ¬¡åˆ¤æ–­ï¼Œå¤„ç†ä¸¤ç§ç†æƒ³æƒ…å†µï¼Œå°±æ˜¯è¦ä¹ˆ`newChildren`çš„åŸæœ‰å¤ç”¨èŠ‚ç‚¹éƒ½æœªåˆ é™¤ï¼Œä¸”æ–°å¢èŠ‚ç‚¹ä½ç½®éƒ½åœ¨å›ºå®šèŒƒå›´å†…ï¼Œè®©å…¶æ—§æœ‰èŠ‚ç‚¹å‡ä¿æŒäº†ç›¸å¯¹ä½ç½®ï¼›è¦ä¹ˆ`newChildren`æ— èŠ‚ç‚¹ç§»åŠ¨ä¸”æ— æ–°å¢èŠ‚ç‚¹ï¼Œä»…ä»…`oldChildren`å­˜åœ¨æŸä¸ªå›ºå®šèŒƒå›´å†…çš„èŠ‚ç‚¹å¸è½½ï¼Œå…¶ä»–èŠ‚ç‚¹ä½ç½®ä¿æŒç›¸å¯¹ä¸å˜ã€‚

### 2.2 èŠ‚ç‚¹ç§»åŠ¨åˆ¤æ–­

å½“ç„¶ï¼Œä¸Šé¢çš„æƒ…å†µå®åœ¨æ˜¯å¤ªç‰¹æ®Šäº†ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘éç†æƒ³æƒ…å†µä¸‹çš„å¤„ç†ï¼Œæ¯”å¦‚å¤´å°¾èŠ‚ç‚¹éƒ½ä¸ç›¸åŒï¼Œæˆ–è€…åªæœ‰éƒ¨åˆ†ç›¸åŒæ—¶çš„æƒ…å†µã€‚é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦å»åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å‘ç”Ÿç§»åŠ¨(å½“ç„¶è¿™å…¶ä¸­è¿˜åŒ…æ‹¬äº†æ–°å¢å­èŠ‚ç‚¹æˆ–æ˜¯å¸è½½æ—§èŠ‚ç‚¹)ã€‚

é‚£ä¹ˆè¯¥å¦‚ä½•åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦ç§»åŠ¨å‘¢ï¼Ÿè¿™é‡Œå¯ä»¥é‡‡å–ç®€å•`Diff`çš„æ–¹æ³•è¿›è¡Œåˆ¤æ–­ï¼Œä¹Ÿå°±æ˜¯å¦‚æœæ²¡æœ‰èŠ‚ç‚¹ç§»åŠ¨çš„è¯ï¼Œå®ƒçš„èŠ‚ç‚¹æ’åº(`key`)åº”è¯¥æ˜¯ä¸¥æ ¼é€’å¢çš„ï¼Œä½†æ˜¯å¦‚æœå­˜åœ¨èŠ‚ç‚¹ç§»åŠ¨ï¼Œé‚£ä¹ˆ`key`ä¸€å®šå°±ä¸å†æ˜¯ä¸¥æ ¼é€’å¢äº†ï¼Œæ‰€ä»¥åœ¨å¿«é€Ÿ`Diff`ä¸­è¿˜æ˜¯ç”¨è¿™ä¸ªç‰¹ç‚¹æ¥åˆ¤æ–­`newChildren`ä¸­æ˜¯å¦å‘ç”Ÿäº†èŠ‚ç‚¹ç§»åŠ¨ã€‚

é‚£ä¹ˆæ¥ä¸‹æ¥å°±å¯ä»¥é€šè¿‡è¿™ä¸ªç‚¹ï¼Œæ¥è¿›è¡Œåˆ¤æ–­ã€‚

```typescript
const quickDiff = function(newChildren: VNode[], oldChildren: VNode[], container: Node) {
    let start = 0;
    let newEnd = newChildren.length - 1;
    let oldEnd = oldChildren.length - 1;
    while(newChildren[start].key === oldChildren[start].key) {
       ......
    }
    while(newChildren[newEnd].key === oldChildren[oldEnd].key) {
        ......
    }
    if(newEnd > start && oldEnd >= start) {
        ......
    }else if(oldEnd > start && newEnd >= start) {
        ......
    }else {
        //NOTE: å› ä¸ºåªä¼šå­˜åœ¨ä¸¤ç§ç†æƒ³æƒ…å†µï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ–°å¢ä¸€ä¸ªelseè¿›å…¥éç†æƒ³å³å¯
        /**
         * @property {boolean} move æ˜¯å¦éœ€è¦ç§»åŠ¨
         * @property {number} newStart newChildrenå¾…å¤„ç†èŠ‚ç‚¹å¼€å§‹ä½ç½®
         * @property {number} oldStart oldChildrenå¾…å¤„ç†èŠ‚ç‚¹å¼€å§‹ä½ç½®
         * @property {number} patched æ›´æ–°è¿‡çš„èŠ‚ç‚¹æ•°é‡
         * @property {number} lastIndex ç›¸å½“äºç®€å•Diffçš„lastIndexï¼Œç”¨æ¥è®°å½•æœ€å¤§çš„èŠ‚ç‚¹çš„ä½ç½®ä¸‹æ ‡ï¼ŒååŠ©åˆ¤æ–­æ˜¯å¦ç§»åŠ¨äº†èŠ‚ç‚¹
         * @property {*} newChildrenKeyIndex ç”¨æ¥æ˜ å°„keyå¯¹åº”åœ¨newChildrenä¸­çš„ä½ç½®ä¸‹æ ‡
         * @property {number} handleCount å‰©ä½™éœ€è¦å¤„ç†çš„newChildrençš„èŠ‚ç‚¹æ•°
         * @property {number[]} source æ˜ å°„è¡¨ï¼Œæ–°èŠ‚ç‚¹ä½ç½®æ˜ å°„åˆ°oldChildrenä¸Šçš„ä½ç½®è®°å½•
         */
        let move = false;
        let newStart = start;
        let oldStart = start;
        let patched = 0;
        let lastIndex = 0;
        let newChildrenKeyIndex = {};
        let handleCount = newEnd - newStart + 1;
        const source = new Array(handleCount).fill(-1);
        //README: é€šè¿‡åˆ›å»ºnewChildrençš„key<=>indexçš„å…³ç³»ï¼Œæ–¹ä¾¿æ¥ä¸‹æ¥åœ¨oldChildrenä¸­åˆ¤æ–­æ˜¯å¦ç§»åŠ¨æä¾›å¿«é€ŸæŸ¥æ‰¾
        for(let i = 0; i < newChildren.length; i++) {
        	newChildrenKeyIndex[newChildren[i].key] = i;
        }
        for(let i = 0; i < oldChildren.length; i++){
            if(patched < handleCount) {
            	//NOTE: é€šè¿‡èŠ‚ç‚¹çš„keyï¼Œæ¥è·å–åœ¨newChildrenä¸­çš„ä½ç½®ä¸‹æ ‡
                let k = newChildrenKeyIndex(oldChildren[i].key);
                if(typeof k !== 'undefined') {
                    //README: å¦‚æœè¿˜å¯ä»¥åœ¨æ–°èŠ‚ç‚¹ç»„é›†åˆä¸­æ‰¾åˆ°å¯¹åº”ä¸‹æ ‡ï¼Œè¯´æ˜èŠ‚ç‚¹è¿˜æ˜¯è¢«å¤ç”¨äº†ï¼Œå°±å¾—å»æ›´æ–°ä¸€ä¸‹
                    patch(oldChildren[i], newChildren[k], container);
                    //NOTE: ç„¶åéœ€è¦ç»´æŠ¤ä¸€ä¸‹æ›´æ–°æ•°ï¼Œæ¯æ›´æ–°ä¸€ä¸ªï¼Œé€’å¢ä¸€ä¸ª
                    patched++;
                    //NOTE: è¿™ä¸ªsourceä¸»è¦æ˜¯ä¸ºäº†ä¹‹åèŠ‚ç‚¹ç§»åŠ¨çš„ä¸€ä¸ªå…³é”®ï¼Œå®ƒä¼šè®°å½•ä¸‹åŸå¯å¤ç”¨èŠ‚ç‚¹åœ¨oldChildrenä¸‹çš„ä½ç½®ä¸‹æ ‡
                    source[k - newStart] = i;
                    //NOTE: ç„¶åå°±æ˜¯èµ‹å€¼ä¸€ä¸ªè®°å½•ä½ç½®ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦æ˜¯é€’å¢åºåˆ—
                    if(k < lastIndex) {
                        move = true;
                    }else {
                        lastIndex = k;
                    }
                }else {
                    //README: å¦‚æœåœ¨newChildrenKeyIndexä¸­æœªæ‰¾åˆ°å¯¹åº”çš„å€¼ï¼Œè¯´æ˜oldChildren[i]èŠ‚ç‚¹åœ¨æ–°èŠ‚ç‚¹ç»„ä¸­è¢«å¸è½½äº†
                    unmount(oldChildren[i]);
                }
            }else {
                //README: å¦‚æœå·²æ›´æ–°çš„èŠ‚ç‚¹æ•°å·²ç»è¶…è¿‡äº†è¶…è¿‡äº†newChildrenå‰©ä½™å¾…å¤„ç†èŠ‚ç‚¹æ•°ï¼Œé‚£ä¹ˆè‚¯å®šå°±æ˜¯å¸è½½çš„äº†
                unmount(oldChildren[i]);
            }
        }
        
    }
}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä½¿ç”¨äº†`newChildrenKeyIndex`è¿™ä¸ªæ˜ å°„å‚æ•°ï¼Œå…ˆè®°å½•ä¸‹äº†`newChildren`ä¸‹èŠ‚ç‚¹`key`å¯¹åº”çš„ä½ç½®ä¸‹æ ‡`index`ä¿¡æ¯ï¼ŒååŠ©åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦ç§»åŠ¨ã€‚

åŒæ—¶åœ¨`oldChildren`éå†ä¸­è·å–åˆ°å¯å¤ç”¨`node`åœ¨`newChildren`çš„ä½ç½®ä¸‹æ ‡æ—¶ï¼Œè¿›ä¸€æ­¥åˆ¤æ–­`oldChildren`ä¸­çš„èŠ‚ç‚¹æ˜¯å¦è¢«å¸è½½ï¼Œå› ä¸ºå¦‚æœ`oldChildren`ä¸­çš„èŠ‚ç‚¹åœ¨`newChildrenKeyIndex`ä¸å­˜åœ¨æ˜ å°„å€¼çš„æ—¶å€™ï¼Œä¼šè¿”å›`undefined`ï¼Œè¿™æ ·å°±å¾ˆå®¹æ˜“ç›´åˆ°è¿™ä¸ªèŠ‚ç‚¹æ˜¯å¦è¢«å¸è½½äº†ã€‚

åœ¨ä»£ç è¿˜è®¾ç½®äº†ä¸€ä¸ª`patched`å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°çš„ä½œç”¨ä¹Ÿå¾ˆæœ‰ç”¨ï¼Œå¦‚æœæ–°èŠ‚ç‚¹ç»„ä¸­çš„å¾…å¤„ç†èŠ‚ç‚¹(å¯å¤ç”¨çš„)éƒ½è¢«å¤„ç†å®Œäº†ï¼Œä½†æ˜¯`oldChildren`ä¸­ä»ç„¶å­˜åœ¨æœªå¤„ç†å®Œæˆçš„èŠ‚ç‚¹æ—¶ï¼Œé‚£ä¹ˆè¯´æ˜**`oldChildren`ä¸­å‰©ä¸‹çš„èŠ‚ç‚¹éƒ½æ˜¯éœ€è¦è¢«å¸è½½çš„ï¼Œå› ä¸º`newChildren`ä¸­éœ€è¦å¤„ç†çš„èŠ‚ç‚¹éƒ½å¤„ç†å®Œäº†ã€‚**é€šè¿‡è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬åˆå¯ä»¥è¿›è¡ŒèŠ‚ç‚¹çš„å¸è½½åˆ¤æ–­äº†ã€‚

æœ€åè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„`source`å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°ä¸»è¦éœ€è¦è®°å½•`newChildren`å¾…å¤„ç†æ•°æ®åœ¨`oldChildren`ä¸­çš„å¯¹åº”ä½ç½®ï¼Œè¿™æ˜¯ä¸ºäº†åé¢èŠ‚ç‚¹ç§»åŠ¨åšå‡†å¤‡çš„ï¼Œæˆ‘ä»¬è¿™é‡Œå°±å…ˆä¸å…·ä½“å±•å¼€è¯´æ˜è¿™ä¸ªå‚æ•°çš„ä½œç”¨äº†ï¼Œåªè¦çŸ¥é“å®ƒè®°å½•äº†å¯å¤ç”¨èŠ‚ç‚¹åœ¨`oldChildren`ä¸­çš„ä½ç½®ã€‚

åˆ°äº†è¿™é‡Œï¼Œæˆ‘ä»¬**å·²ç»å¯ä»¥åˆ¤æ–­å‡ºæ˜¯å¦å­˜åœ¨éœ€è¦ç§»åŠ¨çš„èŠ‚ç‚¹äº†ï¼Œå¹¶ä¸”æˆ‘ä»¬å½»åº•å°†éœ€è¦å¸è½½çš„èŠ‚ç‚¹å…¨éƒ¨å¸è½½å®Œæˆ**äº†ï¼Œä¹‹å**åªéœ€è¦å¤„ç†éœ€è¦ç§»åŠ¨ä»¥åŠæ–°å¢çš„èŠ‚ç‚¹**å°±å®Œäº‹äº†ã€‚

> æœ€ç»ˆæ„å»ºå‡ºæ¥çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤º:
>
> ![quickDiff_build_data](../../image/vue/quickDiff/quickDiff_move_data.jpg)

### 2.3 èŠ‚ç‚¹ç§»åŠ¨

åœ¨åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦è¿›è¡Œç§»åŠ¨ä¹‹å,æˆ‘ä»¬å°±éœ€è¦å¤„ç†éœ€è¦ç§»åŠ¨çš„èŠ‚ç‚¹äº†,è¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ°æˆ‘ä»¬ä¹‹å‰å‡†å¤‡å¥½çš„`source`è¿™ä¸ªæ•°ç»„å•¦ã€‚

`source`æ•°ç»„ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªä½œç”¨ï¼š

1. é€šè¿‡`source`æ•°ç»„æ„å»ºå‡ºæœ€é•¿é€’å¢å­åºåˆ—ï¼Œæ¥ä½œä¸ºé”šç‚¹é€‰å®šç‚¹ï¼Œæ–¹ä¾¿`newChildren`ä¸­éœ€è¦ç§»åŠ¨çš„èŠ‚ç‚¹é€‰ä¸­é”šç‚¹ã€‚
2. åœ¨`source`æ•°ç»„ä¸­å¡«å……äº†-1çš„èŠ‚ç‚¹ï¼Œè¯´æ˜æ˜¯æ–°å¢èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå°±éœ€è¦è¿›è¡ŒæŒ‚è½½æ“ä½œã€‚

åœ¨**1**ä¸­æœ‰æåˆ°éœ€è¦æ„å»ºä¸€ä¸ªæœ€é•¿é€’å¢å­åºåˆ—ï¼Œé‚£ä¹ˆä¸ºå•¥è¦æ„é€ æœ€é•¿é€’å¢å­åºåˆ—å‘¢ï¼Ÿ

1. æœ€é•¿é€’å¢å­åºåˆ—ä¸­çš„å­èŠ‚ç‚¹ï¼Œæ˜¯æŒ‰ç…§é€’å¢é¡ºåºè¿›è¡Œæ’åˆ—çš„ï¼Œè¯´æ˜ä»–ä»¬è¿˜æ˜¯æŒ‰ç…§`oldChildren`èŠ‚ç‚¹é¡ºåºæ¥çš„ï¼Œæ‰€ä»¥ä»–ä»¬çš„ä½ç½®ç›¸å¯¹å›ºå®šï¼Œä¾ç„¶æ˜¯å‰åå…³ç³»ä¸ä¾¿ï¼Œæ‰€ä»¥ä¸è¿›è¡Œä½ç½®æ›´æ–°ã€‚

   > å°±å’Œä¹‹å‰lastIndexåˆ¤æ–­æ˜¯å¦ç§»åŠ¨çš„åŸç†æ˜¯ä¸€æ ·çš„

2. æœ€é•¿é€’å¢å­åºåˆ—çš„æ„å»ºå®Œæˆä¹‹åï¼Œå¯ä»¥å‡å°‘èŠ‚ç‚¹ç§»åŠ¨æ¬¡æ•°ï¼ŒåŠ å¿«èŠ‚ç‚¹ç§»åŠ¨é€Ÿåº¦ã€‚

ä¸Šé¢å°±æ˜¯å®Œæˆæœ€é•¿é€’å¢å­åºåˆ—æ„å»ºçš„2ç‚¹å¥½å¤„ã€‚

> æ³¨ï¼šè¿™é‡Œæ„å»ºçš„æœ€é•¿é€’å¢å­åºåˆ—å¯ä»¥æ˜¯ä¸è¿ç»­çš„ã€‚

#### 2.3.1 æœ€é•¿é€’å¢å­åºåˆ—

æ—¢ç„¶çŸ¥é“äº†æœ€é•¿é€’å¢å­åºåˆ—å¯ä»¥å¸¦æ¥çš„å¥½å¤„ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä»£ç ï¼Œå…ˆæ¥å®ç°ä¸€ä¸‹æœ€é•¿é€’å¢å­åºåˆ—æ„å»ºã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```typescript
const generateLongestSubsequence = function (source: number[]) {
    let len = source.length;
    //NOTE: på…ƒç´ çš„ä½œç”¨å°±æ˜¯ç”¨æ¥è®°å½•æœ€é•¿é€’å¢å­åºåˆ—çš„æ•°æ®çš„
    const p = new Array(len).fill(-1);
    /**
     * @property {number[]} result æœ€ç»ˆè¿”å›çš„æœ€é•¿é€’å¢å­åºåˆ—ä¸‹æ ‡ä½ç½®é›†åˆ
     */
    const result = [0];
    let left, right, mid;
    let j;
    for (let i = 0; i < len; i++) {
        const targetIndex = source[i];
        if (targetIndex !== 0) {
            j = result[result.length - 1];
            //NOTE: åˆ¤æ–­å¯¹æ¯”ç‚¹çš„å¤§å°æ˜¯å¦æ¯”åŸä½ç½®ç‚¹çš„å¤§ï¼Œå¦‚æœå¤§çš„è¯ï¼Œè¯´æ˜æ˜¯é€’å¢ç‚¹ï¼Œç›´æ¥æ”¾å…¥resultï¼Œæ³¨æ„ï¼Œè¿™é‡Œæ”¾çš„æ˜¯ä¸‹æ ‡
            if (source[j] > targetIndex) {
                //NOTE: è¿™é‡Œéœ€è¦è®°å½•ä¸€ä¸‹å½“å‰ç›®æ ‡ç‚¹çš„åä¸€ä½é€’å¢å­èŠ‚ç‚¹çš„ä¸‹æ ‡ï¼Œèµ‹å€¼åˆ°å¤åˆ¶çš„é‚£ä¸ªæ•°ç»„ä¸Š
                p[j] = i;
                result.push(i);
                continue;
            }
            //NOTE: å¦‚æœä¸æ˜¯é€’å¢çš„ï¼Œé‚£ä¹ˆå°±éœ€è¦å»å¯»æ‰¾å‰ç½®çš„ï¼Œå°äºå½“å‰ä½ç½®çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨å¯»æ‰¾å·¦è¾¹ç•Œçš„äºŒåˆ†æŸ¥æ‰¾
            left = 0;
            right = result.length - 1;
            //NOTE: å› ä¸ºresultä¸­å­˜çš„æ˜¯é€’å¢åºåˆ—ä¸”æ˜¯sourceçš„ä¸‹æ ‡å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡source[result[mid]]å–åˆ°å¯¹åº”ä½ç½®
            //README: é€šè¿‡äºŒåˆ†æŸ¥æ‰¾ï¼Œæ‰¾æˆ‘ä»¬å½“å‰ä½ç½®jåœ¨resultä¸­çš„å¯¹åº”ä½ç½®ï¼Œæ˜¯å¦å¯ä»¥å½¢æˆé€’å¢åºåˆ—
            while (left < right) {
                let mid = (left + right) / 2 || 0;
                if (source[result[mid]] < targetIndex) {
                    left = mid + 1;
                } else {
                    right = mid;
                }
            }
            //NOTE: æ ¹æ®å·¦è¾¹ç•Œè¿›è¡Œåˆ¤æ–­ï¼Œä¸‹æ ‡æ˜¯å¦å¤§äºç›®æ ‡èŠ‚ç‚¹ä½ç½®çš„å€¼ï¼Œå¦‚æœå¤§äºï¼Œè¯´æ˜å¯ä»¥å½¢æˆé€’å¢åºåˆ—
            if (targetIndex < source[result[left]]) {
                //NOTE: åˆ¤æ–­leftæ˜¯å¦æ˜¯>0çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–°ä¸€ä¸‹pä¸­å¯¹åº”iä¸‹çš„å€¼ï¼Œä»¥ä¾¿ä¿å­˜é€’å¢å­åºåˆ—çš„ä¸‹æ ‡è®°å½•
                if (left > 0) {
                    p[i] = result[left - 1];
                }
                //README: åŒæ—¶æˆ‘ä»¬è¿˜éœ€å»æ›´æ–°ä¸€ä¸‹resultå¯¹åº”leftä¸‹æ ‡çš„å€¼çš„ç´¢å¼•ä¸ºå½“å‰i
                //NOTE: å› ä¸ºåªéœ€è¦è¿”å›ä¸€ç»„é€’å¢å­åºåˆ—çš„æƒ…å†µï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ›´æ–°
                result[left] = i;
            }
        }
    }
    //æœ€åæˆ‘ä»¬éœ€è¦æŠŠè®°å½•åœ¨pæ•°ç»„ä¸­çš„å¯¹åº”resulté•¿åº¦çš„é€’å¢å­åºåˆ—çš„ä¸‹æ ‡å–å‡ºæ¥ï¼Œæ”¾å…¥resultä¸­è¿›è¡Œè¿”å›
    let pointer = result.length;
    let recordIndex = result[pointer - 1];
    while (pointer-- > 0) {
        result[pointer] = recordIndex;
        recordIndex = p[pointer];
    }
    //NOTE: æœ¬æ–¹æ³•ï¼Œå®é™…ç”¨çš„å°±æ˜¯è´ªå¿ƒ+äºŒåˆ†çš„å½¢å¼ï¼Œè·å–æœ€é•¿é€’å¢å­åºåˆ—
    return result;
}
```

ä¸Šé¢çš„è¿™æ®µä»£ç å°±æ˜¯`vue3`ä¸­ç”¨æ¥å®ç°æœ€é•¿é€’å¢å­åºåˆ—è·å–çš„ä»£ç ï¼Œå½“ç„¶æˆ‘è¿™é‡Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼ŒæŠŠç›¸å…³çš„å˜é‡åè¿›è¡Œäº†ä¿®æ”¹ï¼Œè¿™æ ·æ›´åŠ æ–¹ä¾¿ç†è§£ï¼Œç°åœ¨å°±æ¥ç¨å¾®è§£é‡Šä¸€ä¸‹ï¼Œé…åˆç€ä»£ç ä¸­å·²ç»å†™å¥½çš„æ³¨é‡Šã€‚

**æ­¥éª¤è¯´æ˜**

![longest_increasing_subsquence](../../image/vue/quickDiff/quickDiff_longest_subsquence.jpg)

1. éå†sourceæ•°ç»„ï¼Œç„¶ååˆ¤æ–­å½“å‰ä¸‹æ ‡æ˜¯å¦ä¸º0ï¼Œå¦‚æœæ˜¯0çš„è¯ï¼Œä¸æ‰§è¡Œï¼Œè¿›å…¥ä¸‹ä¸€æ­¥

2. è·å–å½“å‰`result`æœ€åä¸€ä½çš„ä¸‹æ ‡å€¼ï¼Œè¿™ä¸ªå€¼æ˜¯**å½“å‰é€’å¢åºåˆ—çš„æœ€å¤§å€¼**ï¼Œç„¶åè¿›è¡Œå¤§å°çš„åˆ¤æ–­

   > æ­¤æ—¶çš„resultå­˜æ”¾çš„æ•°æ®åªæ˜¯æš‚æ—¶çš„ï¼ŒçœŸæ­£çš„è¿”å›æ•°æ®éƒ½å­˜æ”¾åœ¨`p`ä¸­

   1. å¦‚æœå¤§äºæœ€å¤§å€¼ï¼Œå°±å¾ˆå¥½å¤„ç†ï¼Œç›´æ¥æ”¾å…¥åˆ°`result`æ•°ç»„ä¸­ï¼Œå¹¶ä¸”å°†å…¶è®°å½•åœ¨å¯¹åº”`p`æ•°ç»„çš„å¯¹åº”ä½ç½®ä¸‹ã€‚

   2. å¦‚æœä¸å¤§äºæœ€å¤§å€¼çš„è¯ï¼Œå°±åœ¨`result`ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œå› ä¸º`result`æ˜¯ä¸€ä¸ªé€’å¢åºåˆ—ï¼Œæ‰€ä»¥å¾ˆè‡ªç„¶çš„å°±æ˜¯ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ï¼Œä¸”éœ€è¦æŸ¥æ‰¾çš„æ˜¯å·¦è¾¹ç•Œ

      > è¿™é‡ŒäºŒåˆ†ç”¨å·¦è¾¹ç•ŒæŸ¥æ‰¾ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦æŸ¥æ‰¾æœ€é•¿é€’å¢å­åºåˆ—ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ‰¾åˆ°æœ€é è¿‘çš„æ¯”å½“å‰èŠ‚ç‚¹ä½ç½®å°çš„é‚£ä¸ªèŠ‚ç‚¹ä½ç½®ï¼Œæ‰€ä»¥è¦æ‰¾çš„æ˜¯å°±æ˜¯å·¦è¾¹ç•Œ

   3. å½“æˆ‘ä»¬å¯»æ‰¾åˆ°å¯¹åº”çš„å·¦è¾¹ç•Œ`left`åï¼Œéœ€è¦ä¸å½“å‰çš„`targetIndex`è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå¤§äºï¼Œè¯´æ˜å¯ä»¥å½¢æˆé€’å¢åºåˆ—ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†å½“å‰å€¼è¿›è¡Œæ›¿æ¢ã€‚

      > è¿™é‡Œéœ€è¦å¤„ç†`p`çš„æ•°æ®ï¼Œä½†æ˜¯éœ€è¦åˆ¤æ–­`left`æ˜¯å¦`>0`ï¼Œå› ä¸ºå¦‚æœ`left == 0`ï¼Œå°±ä¼šæ¨ç¿»ä¹‹å‰çš„å…¨éƒ¨ï¼Œæ‰€ä»¥æ˜¯ä¸å¯è¡Œçš„ã€‚ä½†æ˜¯å¦‚æœæ˜¯æ›´æ–°åœ¨resultè¿™ä¸ªä¸´æ—¶çš„æ•°æ®ä¸­æ—¶ï¼Œæ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºä¸ä¼šå½±å“åˆ°æœ€ç»ˆè¿”å›çš„ç»“æœã€‚

3. å½“å¾ªç¯å¤„ç†å®Œä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦å¾—å‡ºæœ€ç»ˆéœ€è¦è¿”å›çš„é€’å¢åºåˆ—çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡è¿™ä¸ª`result`çš„æ•°ç»„é•¿åº¦è¿›è¡Œå¾—å‡ºã€‚ç„¶åå†é€šè¿‡ä¿å­˜çœŸå®è¿”å›èŠ‚ç‚¹æ•°æ®ä¸‹æ ‡å€¼çš„`p`æ•°ç»„è¿›è¡Œè·å–ã€‚

å®é™…ä¸Šå°±æ˜¯ä¸€ç§è´ªå¿ƒ+äºŒåˆ†çš„å¤„ç†æ–¹å¼ï¼Œä¹Ÿå¯ä»¥ç”¨dpæ¥è¿›è¡Œä¹¦å†™ã€‚ä¸è¿‡è´ªå¿ƒ+äºŒåˆ†ä¼šæ›´å¿«ç‚¹

> å› ä¸ºè¿™ä¸ªï¼Œæˆ‘å»åˆ·äº†5é“å…³äºæœ€é•¿å­åºåˆ—çš„å„ç§é—®é¢˜çš„dpé¢˜ç›®ğŸ˜‚

#### 2.3.2 èŠ‚ç‚¹ç§»åŠ¨

å½“æˆ‘ä»¬æ„å»ºå®Œäº†æœ€é•¿é€’å¢å­åºåˆ—åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥è¿›è¡Œæœ€ç»ˆçš„èŠ‚ç‚¹ç§»åŠ¨äº†ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œå…ˆå°†å…¶åŸç†å›¾æ”¾å‡ºæ¥ï¼Œå¤§å®¶å¯ä»¥å…ˆæœ‰ä¸ªåˆæ­¥çš„è®¤è¯†ã€‚

![node_move](../../image/vue/quickDiff/quickDiff_move_action.jpg)

> è¿™é‡Œå¤šè®¾ç½®äº†ä¸€ä¸ªp6èŠ‚ç‚¹ï¼Œå±•ç¤ºæ–°å¢æƒ…å†µ

é€šè¿‡å›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é€šè¿‡ä¹‹å‰æ„å»ºçš„æœ€é•¿é€’å¢å­åºåˆ—å’Œæ˜ å°„è¡¨è®¾ç½®å°¾æŒ‡é’ˆï¼Œä¸€æ­¥ä¸€æ­¥å¤„ç†ï¼Œä¸”å…¶ä¸­ä¸»è¦åˆ†æˆ3ç§æƒ…å†µ

1. `lis[lisEnd] == source[i]`

   å¦‚æœå½“å‰æœ€é•¿é€’å¢å­åºåˆ—æ•°ç»„çš„ä¸‹æ ‡å€¼ç­‰äºåœ¨`oldChildren`ä¸­æ˜ å°„çš„èŠ‚ç‚¹ä½ç½®æ—¶ï¼Œè¯´æ˜å½“å‰ä½ç½®ç›¸å¯¹äºåŸå…ˆçš„ä½ç½®æ¥è¯´å¹¶æ²¡æœ‰è¿›è¡Œç§»åŠ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ç§»åŠ¨æœ€é•¿é€’å¢å­åºåˆ—æ•°ç»„çš„å°¾æŒ‡é’ˆå³å¯ï¼Œæ— éœ€è¿›è¡Œä½ç½®æ›´æ–°ã€‚

2. `source[i] === -1`

   å¦‚æœå½“å‰ä¸‹æ ‡åœ¨`oldChildren`ä¸­çš„æ˜ å°„ä¸º-1ï¼Œé‚£ä¹ˆè¯´æ˜å½“å‰èŠ‚ç‚¹ä¸ºæ–°å¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›è¡Œ`patch`æ“ä½œè€Œä¸æ˜¯`insert`

3. `source[i] !== lis[lisEnd]`

   å¦‚æœå½“å‰æœ€é•¿é€’å¢å­åºåˆ—æ•°ç»„çš„ä¸‹æ ‡å€¼ä¸ç­‰äºåœ¨`oldChildren`ä¸­æ˜ å°„çš„èŠ‚ç‚¹ä½ç½®æ—¶ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹ç›¸å¯¹äºåŸæ¥çš„ä½ç½®å‘ç”Ÿäº†ç§»åŠ¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦è¿›è¡Œ`inseet`æ“ä½œæ¥å°†å…¶æŒ‚è½½åˆ°å¯¹åº”çš„èŠ‚ç‚¹ä¸Šã€‚

æ ¹æ®ä¸Šé¢çš„ä¸‰ç§çŠ¶æ€å°±å¯ä»¥æ¥ç¼–å†™æˆ‘ä»¬çš„å®ç°ä»£ç å•¦

```typescript
if (move) {
    //NOTE: è·å–åˆ°æœ€é•¿é€’å¢å­åºåˆ—ä¹‹åï¼ŒæŒ‰ç…§åŒæŒ‡é’ˆè¿›è¡Œå¾ªç¯
    let lis = generateLongestSubsequence(source);
    //README: lisEndä½œä¸ºlisæœ€é•¿é€’å¢å­åºåˆ—çš„å°¾éƒ¨æŒ‡é’ˆï¼Œç”¨æ¥å¤„ç†éœ€è¦å¤„ç†çš„ä½ç½®
    let lisEnd = lis.length - 1;
    //README: è¿™é‡Œè¦å¤„ç†çš„æ•°æ®çš„é•¿åº¦ï¼Œå°±æ˜¯ä¹‹å‰è·å–åˆ°çš„handleCountçš„é•¿åº¦
    for (let i = handleCount - 1; i >= 0; i--) {
        //NOTE: ç­‰äº-1è¯´æ˜æ˜¯æ–°å¢çš„èŠ‚ç‚¹
        if (source[i] == -1) {
            //NOTE:è¿™é‡ŒPosè¦åŠ ä¸ŠnewStartæ˜¯å› ä¸ºè¿™é‡Œçš„å¼€å§‹ä½ç½®æ˜¯ä»newStartä½ç½®å¼€å§‹çš„ï¼Œå®é™…ä½ç½®åœ¨newChildrenä¸­æ˜¯i+newStart
            const pos = i + newStart;
            const newVNode = newChildren[pos];
            //NOTE: è¿™é‡Œè·å–nextPosï¼Œæ˜¯å› ä¸ºInsertä¸­ç”¨çš„Node.prototype.insertBeforeè¿™ä¸ªæ–¹æ³•
            const nextPos = pos + 1;
            const anchor = nextPos < newChildren.length ? newChildren[nextPos] : null;
            //NOTE: å› ä¸ºæ˜¯æ–°å¢çš„èŠ‚ç‚¹ï¼Œæ‰€ä»¥åªéœ€è¦æŒ‚è½½å³å¯
            this.patch(null, newVNode, container, anchor)
        } else if (i !== lis[lisEnd]) {
            const pos = i + newStart;
            const newVNode = newChildren[pos];
            const nextPos = pos + 1;
            const anchor = nextPos < newChildren.length ? newChildren[nextPos] : null;
            //NOTE: åªéœ€è¦æ›´æ–°ä½ç½®å³å¯ï¼Œä¹‹å‰å·²ç»patchæ›´æ–°è¿‡äº†
            this.insert(newVNode, container, anchor)
        } else {
            //NOTE: ä½ç½®æ²¡æœ‰æ”¹å˜çš„è¯ï¼Œå°¾æŒ‡é’ˆä½ç½®æ›´æ–°
            lisEnd--;
        }
    }
}
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†å¿«é€ŸDiffçš„å…¨éƒ¨ä»£ç ç¼–å†™å•¦ï¼Œæœ€åå†æŠŠå®Œæ•´çš„ä»£ç æ”¾åœ¨ä¸€èµ·ï¼Œæ–¹ä¾¿å¤§å®¶è¿›è¡ŒæŸ¥çœ‹

```typescript
const generateLongestSubsequence = function (source: number[]) {
    let len = source.length;
    const p = source.slice();
    const result = [0];
    let left, right, mid;
    let j;
    for (let i = 0; i < len; i++) {
        const targetIndex = source[i];
        if (targetIndex !== 0) {
            j = result[result.length - 1];
            if (source[j] > targetIndex) {
                p[j] = i;
                result.push(i);
                continue;
            }
            left = 0;
            right = result.length - 1;
            while (left < right) {
                let mid = (left + right) / 2 || 0;
                if (source[result[mid]] < targetIndex) {
                    left = mid + 1;
                } else {
                    right = mid;
                }
            }
            if (targetIndex < source[result[left]]) {
                if (left > 0) {
                    p[i] = result[left - 1];
                }
                result[left] = i;
            }
        }
    }
    let pointer = result.length;
    let recordIndex = result[pointer - 1];
    while (pointer-- > 0) {
        result[pointer] = recordIndex;
        recordIndex = p[pointer];
    }
    return result;
}

const quickDiff = function (newChildren: VNode[], oldChildren: VNode[], container: Node) {
    let j = 0;
    let newEnd = newChildren.length - 1;
    let oldEnd = oldChildren.length - 1;
    while (newChildren[j].key === oldChildren[j].key) {
        this.patch(oldChildren[j], newChildren[j], container);

        j++;
    }
    while (newChildren[newEnd].key === oldChildren[oldEnd].key) {
        this.patch(oldChildren[j], newChildren[j], container);

        newEnd--;
        oldEnd--;
    }
    if (newEnd < j && oldEnd >= j) {
        for (let i = j; i <= oldEnd; i++) {
            this.unmount(oldChildren[i]);
        }
    } else if (newEnd >= j && oldEnd < j) {
        let anchorIndex = newEnd + 1;
        let anchor = anchorIndex < newChildren.length ? newChildren[anchorIndex].el : null;
        for (let i = j; i <= newEnd; i++) {
            this.patch(null, newChildren[i], container, anchor);
        }
    } else {
        let move = false;
        const handleCount = newEnd - j + 1;
        const source = new Array(handleCount).fill(-1);
        const oldStart = j;
        const newStart = j;

        let patched = 0;
        let pos = 0
        let newChildrenKeyIndex = {}
        for (let i = 0; i < newChildren.length; i++) {
            newChildrenKeyIndex[newChildren[i].key] = i;
        }
        for (let i = 0; i < oldChildren.length; i++) {
            let oldNode = oldChildren[i];
            if (patched < handleCount) {
                let k = newChildrenKeyIndex[oldNode.key];
                if (typeof k !== 'undefined') {
                    let newNode = newChildren[k];
                    this.patch(oldNode, newNode, container);
                    patched++;
                    source[k - newStart] = i;
                    if (k < pos) {
                        move = true;
                    } else {
                        pos = k;
                    }
                } else {
                    this.unmount(oldNode);
                }
            } else {
                this.unmount(oldNode);
            }
        }

        if (move) {
            let lis = generateLongestSubsequence(source);
            let lisEnd = lis.length - 1;
            for (let i = handleCount - 1; i >= 0; i--) {
                if (source[i] == -1) {
                    const pos = i + newStart;
                    const newVNode = newChildren[pos];
                    const nextPos = pos + 1;
                    const anchor = nextPos < newChildren.length ? newChildren[nextPos] : null;
                    this.patch(null, newVNode, container, anchor)
                } else if (i !== lis[lisEnd]) {
                    const pos = i + newStart;
                    const newVNode = newChildren[pos];
                    const nextPos = pos + 1;
                    const anchor = nextPos < newChildren.length ? newChildren[nextPos] : null;
                    this.insert(newVNode, container, anchor)
                } else {
                    lisEnd--;
                }
            }
        }
    }
}
```

## ç»“æŸè¯­

å¿«é€ŸDiffçš„è®¾è®¡ååˆ†çš„å·§å¦™ï¼Œä½¿ç”¨ç›¸å…³çš„é¢„å¤„ç†æŠ€æœ¯ï¼Œæ¥å‡å°‘èŠ‚ç‚¹çš„ç§»åŠ¨æ¬¡æ•°ï¼Œæ— è®ºæ˜¯ä¸€å¼€å§‹çš„å‰ç½®èŠ‚ç‚¹ä¸åç½®èŠ‚ç‚¹çš„æ¯”è¾ƒè¿˜æ˜¯ä¹‹åçš„æœ€é•¿é€’å¢å­åºåˆ—çš„ä½¿ç”¨ï¼Œå…¶å®éƒ½å¯ä»¥çœ‹åšæ˜¯é¢„è®¡ç®—ï¼Œä¸è¿‡åœ¨è¿™äº›é¢„ç»“ç®—å¤„ç†ä¸­ï¼Œç©¿æ’è§£å†³äº†èŠ‚ç‚¹å¸è½½ä¸æ·»åŠ ã€‚è¿™æ¯”èµ·ä¹‹å‰çš„åŒç«¯`Diff`è¿›è¡Œæ¯ä¸€ä¸ªèŠ‚ç‚¹æ¯”è¾ƒç§»åŠ¨æ¥è¯´ç¡®å®ä¼˜åŒ–äº†ä¸å°‘ã€‚è¿™é‡Œå±å®çœ‹å‡ºäº†ç®—æ³•çš„é‡è¦æ€§ï¼Œæ‰€ä»¥åˆ·é¢˜è¿˜æ˜¯æœ‰å¿…è¦çš„ğŸ˜‚ã€‚

å¦‚æœæƒ³è¦å¾ˆå¥½åœ°æŒæ¡å¥½å¿«é€ŸDiffï¼Œä¸€å®šè¦å…¶ä¸­å‡ ä¸ªç‚¹ï¼š**å‰ç½®ä¸åç½®é¢„å¤„ç†ï¼Œæœ€é•¿é€’å¢å­åºåˆ—ï¼ŒèŠ‚ç‚¹ç§»åŠ¨**ã€‚è¿™ä¸‰ä¸ªç‚¹æŒæ¡åï¼ŒåŸºæœ¬å°±å¯ä»¥è‡ªå·±ä»å¤´åˆ°å°¾æ’¸å‡ºæ¥äº†ï¼Œè€Œä¸”åœ¨è‡ªå·±å¼€å‘çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥åœ¨å¾ˆå¤šåœ°æ–¹ä½¿ç”¨ç±»ä¼¼çš„æ€æƒ³å»è§£å†³ã€‚åŠ æ²¹åŠ æ²¹åŠ æ²¹ãƒ¾(â—Â°âˆ‡Â°â—)ï¾‰ï¾ã€‚